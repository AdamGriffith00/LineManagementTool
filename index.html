<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gleeds ‚Äì Infrastructure Cost Management Line Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- SheetJS for XLSX/XLS support -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #05060a;
      --bg-card: #101116;
      --bg-card-soft: #171821;
      --border-soft: #262a35;
      --text-main: #f7f7f9;
      --text-soft: #a5aab5;
      --accent-yellow: #ffd400;
      --badge-soft: #171923;

      --green-soft: rgba(46, 204, 113, 0.08);
      --green-border: rgba(46, 204, 113, 0.4);
      --green-text: #55d68a;

      --yellow-soft: rgba(241, 196, 15, 0.12);
      --yellow-border: rgba(241, 196, 15, 0.4);
      --yellow-text: #f5d06a;

      --red-soft: rgba(231, 76, 60, 0.12);
      --red-border: rgba(231, 76, 60, 0.5);
      --red-text: #ff9b8f;

      --radius-card: 18px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #05060a;
      color: var(--text-main);
    }

    .page {
      max-width: 1440px;
      margin: 0 auto;
      padding: 12px 20px 24px;
    }

    /* Header / branding --------------------------------------------------- */

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-logo {
      font-size: 30px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: lowercase;
    }
    .brand-logo::after {
      content: "G";
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin-left: 4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-yellow);
      color: #000;
      font-size: 12px;
      font-weight: 700;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 500;
    }

    .info-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1px solid var(--text-soft);
      background: transparent;
      color: var(--text-soft);
      font-size: 12px;
      font-weight: 700;
      font-style: italic;
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.2s;
    }

    .info-btn:hover {
      background: var(--accent-yellow);
      border-color: var(--accent-yellow);
      color: #000;
    }

    .info-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .info-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .info-modal {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .info-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .info-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-yellow);
    }

    .info-modal-close {
      background: none;
      border: none;
      color: var(--text-soft);
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
    }

    .info-modal-close:hover {
      color: var(--text-main);
    }

    .info-section {
      margin-bottom: 16px;
    }

    .info-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .info-section-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .info-section-list li {
      font-size: 12px;
      color: var(--text-soft);
      padding: 4px 0;
      padding-left: 16px;
      position: relative;
    }

    .info-section-list li::before {
      content: '‚Ä¢';
      position: absolute;
      left: 4px;
      color: var(--accent-yellow);
    }

    /* Change Log Modal */
    .changelog-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .changelog-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .changelog-modal {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .changelog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .changelog-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-yellow);
    }

    .changelog-close {
      background: none;
      border: none;
      color: var(--text-soft);
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
    }

    .changelog-close:hover {
      color: var(--text-main);
    }

    .changelog-section {
      margin-bottom: 16px;
    }

    .changelog-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .changelog-section-title.added { color: #55d68a; }
    .changelog-section-title.removed { color: #ff9b8f; }
    .changelog-section-title.changed { color: #f5d06a; }

    .changelog-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 12px;
      color: var(--text-soft);
    }

    .changelog-list li {
      padding: 4px 0 4px 16px;
      position: relative;
      border-bottom: 1px solid var(--border-soft);
    }

    .changelog-list li:last-child {
      border-bottom: none;
    }

    .changelog-list li::before {
      content: '‚Üí';
      position: absolute;
      left: 0;
      color: var(--text-soft);
    }

    .changelog-empty {
      text-align: center;
      color: var(--text-soft);
      font-size: 13px;
      padding: 20px;
    }

    .top-actions {
      display: flex;
      gap: 8px;
    }

    .btn-top {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #151823;
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
    }
    .btn-top:hover {
      background: #191c29;
    }

    /* Tabs --------------------------------------------------- */

    .tabs-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }

    .tab-btn {
      padding: 8px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-soft);
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #181b27;
      border-color: var(--border-soft);
      color: var(--text-main);
    }

    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* Cards / layout --------------------------------------------------- */

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      border: 1px solid var(--border-soft);
      padding: 14px 16px 16px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
    }

    .card + .card { margin-top: 10px; }

    .pill-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      background: #171923;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .subtle {
      font-size: 13px;
      color: var(--text-soft);
    }

    .summary-line {
      font-size: 20px;
      margin: 4px 0 4px;
    }
    .summary-line .label { opacity: 0.75; }
    .summary-line .value { color: #fff; font-weight: 700; padding: 0 4px; }
    .summary-line .dot { opacity: 0.5; padding: 0 6px; }

    .summary-badges {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .summary-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      background: #171923;
      font-size: 11px;
    }
    .summary-badge span { opacity: 0.8; }
    .summary-badge strong { color: #fff; }

    .summary-warnings {
      margin-top: 12px;
    }

    .summary-warning {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .summary-warning.warning-error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
    }

    .summary-warning.warning-info {
      background: rgba(78, 205, 196, 0.1);
      border: 1px solid rgba(78, 205, 196, 0.3);
      color: #4ecdc4;
    }

    .summary-warning-icon {
      font-size: 14px;
      flex-shrink: 0;
    }

    .summary-warning-content {
      flex: 1;
    }

    .summary-warning-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-warning-list {
      font-size: 11px;
      opacity: 0.9;
      max-height: 80px;
      overflow-y: auto;
    }

    .shell-overview {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }
    @media (max-width: 1100px) {
      .shell-overview {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .stack { display: flex; flex-direction: column; gap: 10px; }

    .field { margin-bottom: 10px; }
    .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #151823;
      color: var(--text-main);
      font-size: 13px;
    }

    .multi-select { position: relative; }
    .multi-select-toggle {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #151823;
      color: var(--text-main);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
    }
    .multi-select-toggle:focus {
      outline: 2px solid rgba(255, 212, 0, 0.4);
      outline-offset: 2px;
    }
    .multi-select-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }
    .multi-select-summary { font-size: 12px; }
    .multi-select-arrow { font-size: 10px; color: var(--text-soft); }
    .multi-select-menu {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      background: #151823;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 8px;
      display: none;
      max-height: 220px;
      overflow-y: auto;
      z-index: 20;
    }
    .multi-select.open .multi-select-menu { display: block; }
    .multi-select-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-main);
    }
    .multi-select-option:hover { background: #1c2030; }
    .multi-select-option input { accent-color: var(--accent-yellow); }

    input[type="file"] {
      font-size: 12px;
      color: var(--text-soft);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #ffd400;
      color: #000;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn:disabled { opacity: 0.4; cursor: default; }
    .btn-ghost {
      background: transparent;
      color: var(--text-main);
    }

    /* People table --------------------------------------------------- */

    .people-table-wrap {
      overflow: auto;
      max-height: 430px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-soft);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #181b23;
      z-index: 5;
    }
    th, td {
      padding: 5px 8px;
      border-bottom: 1px solid #1f2230;
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      color: var(--text-soft);
      text-align: left;
    }
    tbody tr:hover { background: #171b27; }

    /* Row highlighting for issues */
    tbody tr.row-over-capacity {
      background: rgba(255, 107, 107, 0.1);
    }
    tbody tr.row-over-capacity td:first-child {
      border-left: 3px solid #ff6b6b;
    }
    tbody tr.row-orphan {
      background: rgba(255, 193, 7, 0.1);
    }
    tbody tr.row-orphan td:first-child {
      border-left: 3px solid #ffc107;
    }
    tbody tr.row-over-capacity.row-orphan {
      background: rgba(255, 107, 107, 0.15);
    }

    /* Capacity chips --------------------------------------------------- */

    .cap-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      border: 1px solid var(--border-soft);
      background: var(--badge-soft);
    }
    .cap-chip span { opacity: 0.85; }
    .cap-chip strong { font-weight: 600; }

    .cap-under {
      background: var(--green-soft);
      border-color: var(--green-border);
      color: var(--green-text);
    }
    .cap-full {
      background: var(--yellow-soft);
      border-color: var(--yellow-border);
      color: var(--yellow-text);
    }
    .cap-over {
      background: var(--red-soft);
      border-color: var(--red-border);
      color: var(--red-text);
    }

    /* Find a manager --------------------------------------------------- */

    .filters-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    @media (max-width: 700px) {
      .filters-row { grid-template-columns: minmax(0, 1fr); }
    }

    .results-list {
      max-height: 260px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-soft);
      padding: 6px 8px;
      font-size: 12px;
    }
    .manager-row {
      padding: 6px 4px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .manager-row + .manager-row {
      border-top: 1px solid #1f2230;
    }
    .manager-main { display: flex; flex-direction: column; gap: 2px; }
    .manager-main strong { font-size: 13px; }
    .manager-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--text-soft);
    }

    .recommend-score {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .recommend-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(46, 204, 113, 0.15);
      color: #55d68a;
      font-weight: 600;
    }

    .recommend-badge.high {
      background: rgba(46, 204, 113, 0.2);
      color: #4fec94;
    }

    .recommend-badge.medium {
      background: rgba(241, 196, 15, 0.15);
      color: #f5d06a;
    }

    .recommend-badge.low {
      background: rgba(255, 107, 107, 0.15);
      color: #ff9b8f;
    }

    .recommend-reasons {
      font-size: 9px;
      color: var(--text-soft);
      text-align: right;
      max-width: 150px;
    }

    /* Organigram --------------------------------------------------- */

    .org-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .org-tree-wrap {
      max-height: 520px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-soft);
      padding: 8px 10px;
      font-size: 12px;
      position: relative;
    }

    .org-tree-inner {
      transform-origin: top left;
      transition: transform 0.2s ease;
    }

    #orgTreeRoot {
      transform-origin: top left;
      transition: transform 0.2s ease;
    }

    .zoom-controls {
      display: flex;
      gap: 4px;
      margin-left: 16px;
      align-items: flex-end;
    }

    .zoom-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card);
      color: var(--text-main);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .zoom-btn:hover {
      background: var(--accent-yellow);
      color: #000;
      border-color: var(--accent-yellow);
    }

    .zoom-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .zoom-btn:disabled:hover {
      background: var(--bg-card);
      color: var(--text-main);
      border-color: var(--border-soft);
    }

    .zoom-level {
      font-size: 11px;
      color: var(--text-soft);
      min-width: 40px;
      text-align: center;
      line-height: 32px;
    }

    .capacity-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 16px;
      cursor: pointer;
      font-size: 11px;
      color: var(--text-soft);
    }

    .capacity-toggle input {
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    .capacity-toggle:hover {
      color: var(--text-main);
    }

    .export-controls {
      display: flex;
      gap: 6px;
      margin-left: 16px;
      align-items: flex-end;
    }

    .export-controls .btn {
      padding: 6px 12px;
      font-size: 11px;
    }

    /* Capacity color mode */
    .org-tree.color-by-capacity .org-person-card.cap-status-over {
      background: rgba(231, 76, 60, 0.15);
      border-color: rgba(231, 76, 60, 0.5);
    }

    .org-tree.color-by-capacity .org-person-card.cap-status-full {
      background: rgba(241, 196, 15, 0.15);
      border-color: rgba(241, 196, 15, 0.5);
    }

    .org-tree.color-by-capacity .org-person-card.cap-status-under {
      background: rgba(46, 204, 113, 0.15);
      border-color: rgba(46, 204, 113, 0.5);
    }

    .org-group {
      border: 1px solid var(--border-soft);
      border-radius: 14px;
      padding: 10px 12px;
      background: #0f1118;
      margin-bottom: 8px;
    }

    .org-group-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 10px 12px;
      background: #0f1118;
      margin-bottom: 8px;
    }

    .org-group-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 200px;
    }

    .org-group-label strong {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 13px;
    }

    .org-group-label span {
      color: var(--text-soft);
      font-size: 12px;
    }

    .org-group-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .org-group-header {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      cursor: pointer;
    }

    .org-group-title {
      font-size: 13px;
      color: var(--text-main);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    .org-group-meta {
      color: var(--text-soft);
      font-size: 12px;
      flex: 1;
      padding-left: 8px;
    }

    .org-group-actions { display: flex; gap: 6px; align-items: center; }

    .org-tree-detail {
      margin-top: 10px;
      padding: 12px;
      border: 1px dashed var(--border-soft);
      border-radius: 14px;
      background: #0d0f17;
    }

    .org-level-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      justify-content: center;

      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    .org-level-row::-webkit-scrollbar {
      height: 6px;
    }

    .org-level-row::-webkit-scrollbar-track {
      background: transparent;
    }

    .org-level-row::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
    }

    .org-card {
      padding: 8px 10px;
      border-radius: 999px;
      background: #141824;
      border: 1px solid var(--border-soft);
      min-width: 160px;
      text-align: center;
    }

    .org-person-card.org-highlight-manager {
      box-shadow: 0 0 0 4px #ffd500;
      transform: scale(1.03);
      z-index: 2;
    }

    .org-person-card.org-highlight-report {
      box-shadow: 0 0 0 3px #ffd500;
      z-index: 1;
    }

    .org-name { font-weight: 700; font-size: 13px; }
    .org-meta { color: var(--text-soft); font-size: 12px; margin-top: 2px; }
    .org-cap { margin-top: 6px; display: flex; justify-content: center; }

    .org-node-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid #262a35;
      background: #111420;
    }

    .org-node-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid #262a35;
      background: #111420;
    }

    .org-person {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #141824;
      border: 1px solid #262a35;
    }
    .org-person-name { font-size: 12px; }
    .org-person-role {
      font-size: 11px;
      color: var(--text-soft);
    }

    /* Family Tree Styles */
    .org-tree-container {
      position: relative;
      padding: 20px;
    }

    .org-tree-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .org-tree-content {
      position: relative;
      z-index: 1;
    }

    /* Connection lines - hidden by default */
    .org-connection-line {
      stroke: var(--border-soft);
      stroke-width: 2;
      fill: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    /* Line to manager - blue/cyan */
    .org-connection-line.show-manager {
      opacity: 1;
      stroke: #4ecdc4;
      stroke-width: 3;
    }

    /* Line to direct report - yellow */
    .org-connection-line.show-report {
      opacity: 1;
      stroke: var(--accent-yellow);
      stroke-width: 3;
    }

    .org-person-card {
      position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* Selected person - yellow */
    .org-person-card.org-highlight-selected {
      box-shadow: 0 0 0 4px var(--accent-yellow);
      transform: scale(1.05);
      z-index: 10;
    }

    /* Manager of selected person - cyan/teal */
    .org-person-card.org-highlight-manager {
      box-shadow: 0 0 0 4px #4ecdc4;
      transform: scale(1.03);
      z-index: 5;
    }

    /* Over-capacity manager - subtle indicator on organigram */
    .org-person-card.org-over-capacity {
      border-left: 3px solid #ff6b6b;
    }

    /* Team size badge */
    .org-team-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .org-team-badge .team-count {
      background: rgba(255, 212, 0, 0.15);
      color: var(--accent-yellow);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    /* Direct report of selected person - yellow (lighter) */
    .org-person-card.org-highlight-report {
      box-shadow: 0 0 0 3px rgba(255, 212, 0, 0.7);
      z-index: 5;
    }

    .org-level-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 8px;
      padding-left: 4px;
    }

    .org-level-section {
      margin-bottom: 16px;
    }

    /* Legend for the relationship colors */
    .org-legend {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .org-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .org-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .org-legend-color.selected { background: var(--accent-yellow); }
    .org-legend-color.manager { background: #4ecdc4; }
    .org-legend-color.report { background: rgba(255, 212, 0, 0.7); }

    /* Out-of-group relationship info */
    .org-external-info {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      z-index: 100;
      max-width: 400px;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .org-external-info-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-main);
    }

    .org-external-info-item {
      font-size: 12px;
      color: var(--text-soft);
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .org-external-info-item .badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
    }

    .org-external-info-item .badge.manager {
      background: rgba(78, 205, 196, 0.2);
      color: #4ecdc4;
      border: 1px solid rgba(78, 205, 196, 0.4);
    }

    .org-external-info-item .badge.reports {
      background: rgba(255, 212, 0, 0.15);
      color: var(--accent-yellow);
      border: 1px solid rgba(255, 212, 0, 0.4);
    }

    .org-external-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: var(--text-soft);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }

    .org-external-close:hover {
      color: var(--text-main);
    }
  </style>
</head>
<body>
<div class="page">
  <header class="topbar">
    <div class="brand">
      <div class="brand-logo">gleeds</div>
      <div class="brand-title">Infrastructure Cost Management Line Management</div>
      <button class="info-btn" id="infoBtn" title="About this tool">i</button>
    </div>
    <div class="top-actions">
      <button class="btn-top" id="btnLoad">Load CSV/XLSX‚Ä¶</button>
      <button class="btn-top" id="btnExport">Export CSV</button>
      <button class="btn-top" id="btnClear">Clear stored data</button>
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none;">
    </div>
  </header>

  <div class="tabs-row">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="organigram">Organigram</button>
  </div>

  <!-- OVERVIEW TAB -------------------------------------------------- -->
  <section id="tab-overview" class="tab-panel active">
    <div class="shell-overview">
      <div class="stack">
        <div class="card">
          <div class="pill-label">Summary</div>
          <div class="summary-line" id="summaryLine">
            <span class="label">People:</span> <span class="value">0</span>
            <span class="dot">‚Ä¢</span>
            <span class="label">Managers:</span> <span class="value">0</span>
          </div>
          <div class="summary-badges" id="summaryBadges">
            <div class="summary-badge"><span>Under capacity</span> <strong>0</strong></div>
            <div class="summary-badge"><span>At capacity</span> <strong>0</strong></div>
            <div class="summary-badge"><span>Over capacity</span> <strong>0</strong></div>
          </div>
          <div class="summary-warnings" id="summaryWarnings"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div class="pill-label">People</div>
            <div class="field" style="margin:0;width:200px;">
              <div class="field-label">Quick search</div>
              <input type="text" id="peopleSearch" placeholder="Name, office, region‚Ä¶">
            </div>
          </div>
          <div class="people-table-wrap">
            <table id="peopleTable">
              <thead><tr id="peopleHeadRow"></tr></thead>
              <tbody id="peopleBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="stack">
        <div class="card">
          <div class="pill-label">Find a line manager</div>
          <div class="filters-row">
            <div class="field">
              <div class="multi-select" data-filter="region">
                <button type="button" class="multi-select-toggle">
                  <span class="multi-select-label">Region</span>
                  <span class="multi-select-summary">Any</span>
                  <span class="multi-select-arrow">‚ñº</span>
                </button>
                <div class="multi-select-menu"></div>
              </div>
            </div>
            <div class="field">
              <div class="multi-select" data-filter="office">
                <button type="button" class="multi-select-toggle">
                  <span class="multi-select-label">Office</span>
                  <span class="multi-select-summary">Any</span>
                  <span class="multi-select-arrow">‚ñº</span>
                </button>
                <div class="multi-select-menu"></div>
              </div>
            </div>
            <div class="field">
              <div class="multi-select" data-filter="grade">
                <button type="button" class="multi-select-toggle">
                  <span class="multi-select-label">Grade (manager)</span>
                  <span class="multi-select-summary">Any</span>
                  <span class="multi-select-arrow">‚ñº</span>
                </button>
                <div class="multi-select-menu"></div>
              </div>
            </div>
            <div class="field">
              <div class="field-label">Minimum free capacity</div>
              <input type="number" id="fmFreeCap" min="0" value="1">
            </div>
          </div>
          <div class="field" style="margin-bottom:6px;">
            <button class="btn" id="fmSearchBtn" disabled>Suggest</button>
            <button class="btn btn-ghost" id="fmClearBtn" disabled style="margin-left:6px;">Clear</button>
          </div>
          <div class="results-list" id="fmResults">
            <div class="subtle">Upload a file first, then use the filters and click <strong>Suggest</strong>.</div>
          </div>
        </div>

        <div class="card" id="manager-capacity-panel">
          <div class="pill-label">Line managers by region</div>
          <div class="field">
            <div class="field-label">Recommend for person (optional)</div>
            <input type="text" id="capacity-recommend-for" placeholder="Type name..." list="capacity-person-list">
            <datalist id="capacity-person-list"></datalist>
          </div>
          <div class="field">
            <div class="field-label">Region</div>
            <select id="capacity-region">
              <option value="Any">Any region</option>
            </select>
          </div>
          <div class="field">
            <div class="field-label">Office</div>
            <select id="capacity-office">
              <option value="Any">Any office</option>
            </select>
          </div>
          <div class="field">
            <div class="field-label">Capacity status</div>
            <select id="capacity-status">
              <option value="any">Any</option>
              <option value="under">Under capacity</option>
              <option value="full">At capacity</option>
              <option value="over">Over capacity</option>
            </select>
          </div>
          <div class="field" style="display:flex;gap:6px;">
            <button class="btn" id="capacity-search">Search</button>
            <button class="btn btn-ghost" id="capacity-clear">Clear</button>
          </div>
          <div id="capacity-results" class="results-list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ORGANIGRAM TAB ------------------------------------------------ -->
  <section id="tab-organigram" class="tab-panel">
    <div class="card">
      <div class="pill-label">Organigram</div>
      <div class="org-controls">
        <div class="field" style="min-width:140px;margin-bottom:0;">
          <div class="field-label">View</div>
          <select id="orgGroupBy">
            <option value="overall" selected>Overall</option>
            <option value="region">By Region</option>
            <option value="office">By Office</option>
            <option value="person">Find Person</option>
          </select>
        </div>
        <div class="field" id="orgSubGroupField" style="min-width:160px;margin-bottom:0;display:none;">
          <div class="field-label">Select <span id="orgSubGroupLabel">Region</span></div>
          <select id="orgSubGroupSelect">
            <option value="">-- Select --</option>
          </select>
        </div>
        <div class="field" id="orgPersonSearchField" style="min-width:220px;margin-bottom:0;display:none;">
          <div class="field-label">Search person</div>
          <input type="text" id="orgPersonSearch" placeholder="Type name..." list="orgPersonList">
          <datalist id="orgPersonList"></datalist>
        </div>
        <button class="btn btn-ghost" id="orgClearBtn" style="align-self:flex-end;">Clear</button>
        <div class="zoom-controls">
          <button class="zoom-btn" id="zoomOut" title="Zoom out">‚àí</button>
          <span class="zoom-level" id="zoomLevel">100%</span>
          <button class="zoom-btn" id="zoomIn" title="Zoom in">+</button>
          <button class="zoom-btn" id="zoomReset" title="Reset zoom">‚ü≤</button>
        </div>
        <label class="capacity-toggle" title="Color cards by capacity status">
          <input type="checkbox" id="colorByCapacity">
          <span class="toggle-label">Color by capacity</span>
        </label>
        <div class="export-controls">
          <button class="btn btn-ghost" id="exportOrgPng" title="Export as PNG">Export PNG</button>
          <button class="btn btn-ghost" id="exportOrgPdf" title="Export as PDF">Export PDF</button>
        </div>
      </div>
      <div class="org-tree-wrap">
        <div id="orgTreeRoot" class="org-tree">
          <div class="subtle">Upload a file on the Overview tab to see the organigram.</div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Info Modal -->
<div class="info-modal-overlay" id="infoModal">
  <div class="info-modal">
    <div class="info-modal-header">
      <div class="info-modal-title">Line Management Tool Features</div>
      <button class="info-modal-close" id="infoModalClose">√ó</button>
    </div>

    <div class="info-section">
      <div class="info-section-title">üìä Overview Tab</div>
      <ul class="info-section-list">
        <li>View all employees in a searchable, sortable table</li>
        <li>See capacity summary (under/at/over capacity managers)</li>
        <li>Automatic detection of orphans (manager not in system)</li>
        <li>Automatic detection of circular reporting chains</li>
      </ul>
    </div>

    <div class="info-section">
      <div class="info-section-title">üîç Find a Manager</div>
      <ul class="info-section-list">
        <li>Filter by region, office, and grade</li>
        <li>Find managers with available capacity</li>
        <li>Set minimum free capacity requirement</li>
      </ul>
    </div>

    <div class="info-section">
      <div class="info-section-title">üë• Line Managers by Region</div>
      <ul class="info-section-list">
        <li>Search managers by region and office</li>
        <li>Filter by capacity status</li>
        <li>Quick overview of manager availability</li>
      </ul>
    </div>

    <div class="info-section">
      <div class="info-section-title">üå≥ Organigram Tab</div>
      <ul class="info-section-list">
        <li>View hierarchy by Overall, Region, or Office</li>
        <li>Find Person: See anyone's complete reporting chain (managers above, reports below)</li>
        <li>Click any person to highlight their manager and direct reports</li>
        <li>Connection lines show reporting relationships</li>
        <li>Over-capacity managers highlighted in red</li>
        <li>Team size badges show total direct + indirect reports</li>
        <li>Out-of-group info popup when manager/reports are in different regions</li>
      </ul>
    </div>

    <div class="info-section">
      <div class="info-section-title">üìÅ Data Management</div>
      <ul class="info-section-list">
        <li>Import CSV or Excel files</li>
        <li>Export data as CSV</li>
        <li>Clear stored data anytime</li>
      </ul>
    </div>
  </div>
</div>

<!-- Change Log Modal -->
<div class="changelog-modal-overlay" id="changelogModal">
  <div class="changelog-modal">
    <div class="changelog-header">
      <div class="changelog-title">Changes Detected</div>
      <button class="changelog-close" id="changelogClose">√ó</button>
    </div>
    <div id="changelogContent">
      <!-- Content will be populated dynamically -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<script>
(function(){
  // --- Canonical columns / aliases ---------------------------------------
  const ALIAS = {
    Surname: ['Surname','Last Name','LastName','Family Name'],
    FirstForename: ['First Forename','FirstForename','First Name','FirstName','Forename'],
    CostCentre: ['Cost Centre','CostCentre','Cost centre'],
    Grade: ['Grade'],
    GradeLevel: ['Grade Level','GradeLevel','Level','Band'],
    Discipline: ['Discipline','Function','Department','Practice'],
    Office: ['Office','Office/Location','Location','Base Office'],
    Region: ['Region','Area','Region/Area','Geography','Territory'],
    Area: ['Area','Sub Region','Sub-Region','Subregion'],
    Technical: ['Technical','Technical/Operational'],
    DirectorName: ['Director Name','Director','Line Director'],
    Manager: ['Manager','Line Manager','Reporting Manager','Reports To','Manager Name'],
    Appraiser: ['Appraiser','Reviewer'],
    ExpenseApprover: ['Expense Approver','Expenses Approver','ExpenseApprover'],
    IsManager: ['Is Manager','IsManager','Manager?'],
    IsDirector: ['Is Director','IsDirector','Director?'],
    IsAppraiser: ['Is Appraiser','IsAppraiser','Appraiser?'],
    Capacity: ['Capacity','Line Capacity','line_capacity']
  };

  const state = {
    rawObjects: [],
    people: [],
    managersByName: new Map(),
    orgTreesByGroup: {},
  };

  const GRADE_ORDER = [
    'Senior Director',
    'Director',
    'Project Director',
    'Associate Director',
    'Executive Cost Manager',
    'Senior Cost Manager',
    'Cost Manager',
    'Assistant Cost Manager',
    'Graduate Cost Manager',
    'Trainee Cost Manager'
  ];

  // --- Utility ------------------------------------------------------------
  function norm(s){ return (s||'').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,''); }
  function swapCommaName(name){
    if (!name) return '';
    const parts = name.split(',').map(p=>p.trim()).filter(Boolean);
    if (parts.length === 2){
      return `${parts[1]} ${parts[0]}`;
    }
    return name.replace(/\s+/g,' ');
  }
  function canonicalKey(value){
    const base = swapCommaName((value||'').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,''));
    return base.toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
  }

  function tidyLabel(value){
    return (value||'').toString().replace(/\s+/g,' ').trim();
  }

  function gradeForCapacity(value){
    const clean = tidyLabel(value);
    const lower = clean.toLowerCase();
    // Treat bare Cost Manager / Quantity Surveyor roles as Professional for
    // capacity defaults while leaving the displayed grade untouched.
    if (lower === 'cost manager' || lower === 'quantity surveyor'){
      return 'Professional';
    }
    return clean;
  }

  function buildKeyMap(firstRow){
    const keys = Object.keys(firstRow || {});
    const keysNorm = keys.map(k=>norm(k));
    const map = {};
    for (const [canon, aliases] of Object.entries(ALIAS)){
      const candidates = [canon, ...aliases];
      const normCands = candidates.map(c=>norm(c));
      let hit = null;
      hit = keys.find(k => candidates.includes(k));
      if (!hit){
        const idx = keysNorm.findIndex(k => normCands.includes(k));
        if (idx >= 0) hit = keys[idx];
      }
      if (hit) map[canon] = hit;
    }
    return map;
  }

  function getVal(map, row, canon){
    const actual = map[canon];
    return actual ? (row[actual] ?? '') : '';
  }

  function toBool(v){
    const t = (v||'').toString().trim().toLowerCase();
    return t === 'y' || t === 'yes' || t === 'true' || t === '1';
  }

  function toNum(v){
    const n = parseFloat((v||'').toString().replace(',','.'));
    return isNaN(n) ? 0 : n;
  }

  function capacityDelta(person) {
    const cap = Number(person.Capacity || 0);
    const used = Number(person.currentReports || 0);
    return used - cap; // > 0 over capacity, < 0 under, 0 at
  }

  function freeCapacity(person) {
    const cap = Number(person.Capacity || 0);
    const used = Number(person.currentReports || 0);
    return cap - used; // > 0 free, < 0 over, 0 at
  }

  // --- Change Log Functions ------------------------------------------------
  function calculateChanges(oldPeople, newPeople) {
    const changes = {
      added: [],
      removed: [],
      managerChanged: [],
      officeChanged: [],
      regionChanged: []
    };

    const oldMap = new Map();
    (oldPeople || []).forEach(p => {
      const key = canonicalName(p.FullName || p.Name);
      if (key) oldMap.set(key, p);
    });

    const newMap = new Map();
    (newPeople || []).forEach(p => {
      const key = canonicalName(p.FullName || p.Name);
      if (key) newMap.set(key, p);
    });

    // Find added people
    newMap.forEach((newP, key) => {
      if (!oldMap.has(key)) {
        changes.added.push(newP.FullName || newP.Name);
      }
    });

    // Find removed people and changes
    oldMap.forEach((oldP, key) => {
      if (!newMap.has(key)) {
        changes.removed.push(oldP.FullName || oldP.Name);
      } else {
        const newP = newMap.get(key);
        const name = oldP.FullName || oldP.Name;

        // Manager changed
        const oldMgr = (oldP.Manager || '').trim();
        const newMgr = (newP.Manager || '').trim();
        if (oldMgr !== newMgr) {
          changes.managerChanged.push({
            name,
            from: oldMgr || '(none)',
            to: newMgr || '(none)'
          });
        }

        // Office changed
        const oldOffice = (oldP.Office || '').trim();
        const newOffice = (newP.Office || '').trim();
        if (oldOffice !== newOffice) {
          changes.officeChanged.push({
            name,
            from: oldOffice || '(none)',
            to: newOffice || '(none)'
          });
        }

        // Region changed
        const oldRegion = (oldP.Region || '').trim();
        const newRegion = (newP.Region || '').trim();
        if (oldRegion !== newRegion) {
          changes.regionChanged.push({
            name,
            from: oldRegion || '(none)',
            to: newRegion || '(none)'
          });
        }
      }
    });

    return changes;
  }

  function hasChanges(changes) {
    return changes.added.length > 0 ||
           changes.removed.length > 0 ||
           changes.managerChanged.length > 0 ||
           changes.officeChanged.length > 0 ||
           changes.regionChanged.length > 0;
  }

  function showChangeLogModal(changes) {
    const modal = document.getElementById('changelogModal');
    const content = document.getElementById('changelogContent');
    if (!modal || !content) return;

    let html = '';

    if (changes.added.length > 0) {
      html += `
        <div class="changelog-section">
          <div class="changelog-section-title added">+ People Added (${changes.added.length})</div>
          <ul class="changelog-list">
            ${changes.added.map(name => `<li>${name}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    if (changes.removed.length > 0) {
      html += `
        <div class="changelog-section">
          <div class="changelog-section-title removed">‚àí People Removed (${changes.removed.length})</div>
          <ul class="changelog-list">
            ${changes.removed.map(name => `<li>${name}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    if (changes.managerChanged.length > 0) {
      html += `
        <div class="changelog-section">
          <div class="changelog-section-title changed">‚Üî Manager Changed (${changes.managerChanged.length})</div>
          <ul class="changelog-list">
            ${changes.managerChanged.map(c => `<li><strong>${c.name}</strong>: ${c.from} ‚Üí ${c.to}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    if (changes.officeChanged.length > 0) {
      html += `
        <div class="changelog-section">
          <div class="changelog-section-title changed">üè¢ Office Changed (${changes.officeChanged.length})</div>
          <ul class="changelog-list">
            ${changes.officeChanged.map(c => `<li><strong>${c.name}</strong>: ${c.from} ‚Üí ${c.to}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    if (changes.regionChanged.length > 0) {
      html += `
        <div class="changelog-section">
          <div class="changelog-section-title changed">üåç Region Changed (${changes.regionChanged.length})</div>
          <ul class="changelog-list">
            ${changes.regionChanged.map(c => `<li><strong>${c.name}</strong>: ${c.from} ‚Üí ${c.to}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    if (!html) {
      html = '<div class="changelog-empty">No changes detected from the previous data.</div>';
    }

    content.innerHTML = html;
    modal.classList.add('active');
  }

  function getOfficesForRegion(regionOrRegions) {
    const regions = Array.isArray(regionOrRegions) ? regionOrRegions : [regionOrRegions];
    const regionSet = new Set(regions.filter(Boolean));
    const includeAll = regionSet.size === 0 || regionSet.has('Any');
    const offices = new Set();
    (state.people || []).forEach(p => {
      if (!p.Office) return;
      if (includeAll || regionSet.has(p.Region || '')) {
        offices.add(p.Office);
      }
    });
    return Array.from(offices).sort();
  }

  function populateOfficeSelect(selectEl, regionOrRegions) {
    if (!selectEl) return;
    const offices = getOfficesForRegion(regionOrRegions);
    let html = '<option value="Any">Any office</option>';
    offices.forEach(office => {
      html += `<option value="${office}">${office}</option>`;
    });
    selectEl.innerHTML = html;
  }

  function capacityMeta(p){
    const used = p.currentReports || 0;
    const cap = p.Capacity || 0;
    const status = p.capStatus || 'full';
    const cls = status==='under' ? 'cap-chip cap-under'
              : status==='full' ? 'cap-chip cap-full'
              : 'cap-chip cap-over';
    const label = status==='under' ? 'Under'
                : status==='full' ? 'At'
                : 'Over';
    return {used, cap, cls, label};
  }

  function capacityChip(p, {showIfNonManager=false}={}){
    if (!p) return '';
    const isMgr = p.IsManager || p.currentReports>0;
    if (!showIfNonManager && !isMgr) return `${p.Capacity || 0}`;
    const meta = capacityMeta(p);
    return `<span class="${meta.cls}"><span>${meta.label}</span><strong>‚Ä¢ ${meta.used} / ${meta.cap}</strong></span>`;
  }

  // --- CSV / XLSX parsing -------------------------------------------------
  function detectDelimiter(sample){
    const cands = [',',';','\t','|'];
    const counts = {',':0,';':0,'\t':0,'|':0};
    let inq=false;
    for (let i=0;i<sample.length;i++){
      const ch=sample[i];
      if(ch=='"'){
        if(sample[i+1]=='"'){i++;continue;}
        inq=!inq;
      } else if(!inq && counts.hasOwnProperty(ch)){
        counts[ch]++;
      }
    }
    let best=',',bestN=-1;
    for(const d of cands){ if(counts[d]>bestN){bestN=counts[d];best=d;} }
    return best;
  }

  function parseCSVAuto(text){
    if (!text) return [];
    text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    const delim = detectDelimiter(text.slice(0,2000));
    const rows=[]; let row=[], val='', i=0, inq=false;
    while(i<text.length){
      const ch=text[i];
      if(inq){
        if(ch=='"'){
          if(text[i+1]=='"'){val+='"';i+=2;continue;}
          inq=false;i++;continue;
        }
        val+=ch;i++;continue;
      } else {
        if(ch=='"'){inq=true;i++;continue;}
        if(ch===delim){row.push(val);val='';i++;continue;}
        if(ch=='\n'){row.push(val);rows.push(row);row=[];val='';i++;continue;}
        val+=ch;i++;continue;
      }
    }
    row.push(val); rows.push(row);
    if(rows.length && rows[rows.length-1].every(c=>!String(c||'').trim())) rows.pop();
    return rows;
  }

  function rowsToObjects(rows){
    if (!rows.length) return [];
    while(rows.length && rows[0].every(c=>!String(c||'').trim())) rows.shift();
    if (!rows.length) return [];
    const heads = rows[0].map(h=>{
      const clean = (h||'').replace(/^\ufeff/,'');
      return clean.trim();
    });
    return rows.slice(1).map(r=>{
      const o={};
      heads.forEach((h,idx)=>{ o[h] = (r[idx] ?? ''); });
      return o;
    });
  }

  function xlsxToObjects(buf){
    const wb = XLSX.read(buf,{type:'array'});
    const sheetName = wb.SheetNames[0];
    const sheet = wb.Sheets[sheetName];
    return XLSX.utils.sheet_to_json(sheet, {defval:'', raw:false});
  }

  function handleFile(file){
    if (!file) return;
    const name = file.name.toLowerCase();
    const reader = new FileReader();
    reader.onload = e=>{
      const buf = e.target.result;
      const u8 = new Uint8Array(buf);
      const looksZip = u8.length>=2 && u8[0]===0x50 && u8[1]===0x4b;
      try{
        let objs=[];
        if (looksZip || name.endsWith('.xlsx') || name.endsWith('.xls')){
          objs = xlsxToObjects(buf);
        } else {
          let text = new TextDecoder('utf-8',{fatal:false}).decode(buf);
          let rows = parseCSVAuto(text);
          objs = rowsToObjects(rows);
          if (!objs.length){
            const text2 = new TextDecoder('utf-16le',{fatal:false}).decode(buf);
            rows = parseCSVAuto(text2);
            objs = rowsToObjects(rows);
          }
        }
        processObjects(objs);
      }catch(err){
        console.error(err);
        alert('Could not read file. Please save as CSV (UTF-8) or XLSX and try again.');
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // --- Capacity by grade rules -------------------------------------------
  function gradeDefaultCapacity(grade, gradeLevel){
    const s = ((grade || '') + ' ' + (gradeLevel || '')).toLowerCase();
    let cap = 0;
    if (s.includes('senior director')) cap = 10;
    else if (s.includes('project director')) cap = 8;
    else if (s.includes('associate')) cap = 6;      // Associate Director
    else if (s.includes('director')) cap = 10;      // plain Director
    else if (s.includes('executive')) cap = 5;      // Executive Cost Manager
    else if (s.includes('senior')) cap = 4;         // Senior Cost Manager
    else if (s.includes('professional')) cap = 3;   // Professional Cost Manager
    else if (s.includes('assistant')) cap = 2;      // Assistant Cost Manager
    return cap;
  }

  // --- Process into canonical people -------------------------------------
  function processObjects(objs){
    // Save old people for change log comparison
    const oldPeople = state.people ? [...state.people] : [];

    if (!objs || !objs.length){
      state.rawObjects = [];
      state.people = [];
      renderAll();
      return;
    }
    const keyMap = buildKeyMap(objs[0]);
    const people = objs.map((row, idx)=>{
      const p = {};
      p.id = 'p'+(idx+1);
      p.Surname = tidyLabel(getVal(keyMap,row,'Surname'));
      p.FirstForename = tidyLabel(getVal(keyMap,row,'FirstForename'));
      p.CostCentre = tidyLabel(getVal(keyMap,row,'CostCentre'));
      const gradeRaw = tidyLabel(getVal(keyMap,row,'Grade'));
      p.Grade = gradeRaw; // Preserve uploaded grade for display
      p.GradeLevel = tidyLabel(getVal(keyMap,row,'GradeLevel'));
      p.Discipline = tidyLabel(getVal(keyMap,row,'Discipline'));
      p.Office = tidyLabel(getVal(keyMap,row,'Office'));
      p.Region = tidyLabel(getVal(keyMap,row,'Region'));
      p.Area = tidyLabel(getVal(keyMap,row,'Area'));
      p.Technical = tidyLabel(getVal(keyMap,row,'Technical'));
      p.DirectorName = tidyLabel(getVal(keyMap,row,'DirectorName'));
      p.Manager = tidyLabel(getVal(keyMap,row,'Manager'));
      p.Appraiser = tidyLabel(getVal(keyMap,row,'Appraiser'));
      p.ExpenseApprover = tidyLabel(getVal(keyMap,row,'ExpenseApprover'));
      p.IsManager = toBool(getVal(keyMap,row,'IsManager'));
      p.IsDirector = toBool(getVal(keyMap,row,'IsDirector'));
      p.IsAppraiser = toBool(getVal(keyMap,row,'IsAppraiser'));
      p.Capacity = toNum(getVal(keyMap,row,'Capacity'));
      // apply grade rules if capacity not set or zero
      if (!p.Capacity || p.Capacity <= 0){
        const gradeForCap = gradeForCapacity(p.Grade);
        p.Capacity = gradeDefaultCapacity(gradeForCap, p.GradeLevel);
      }
      p.FullName = (p.FirstForename + ' ' + p.Surname).trim();
      p.fullNameKey = canonicalKey(p.FullName);
      p.managerKey = canonicalKey(p.Manager);
      return p;
    });

    const byName = new Map();
    people.forEach(p=>{ if (p.fullNameKey) byName.set(p.fullNameKey, p); });
    people.forEach(p=>{ p.currentReports = 0; });
    people.forEach(p=>{
      const mgr = p.managerKey;
      if (!mgr) return;
      const m = byName.get(mgr);
      if (m) m.currentReports++;
    });

    people.forEach(p=>{
      const cap = p.Capacity || 0;
      const used = p.currentReports || 0;
      const free = cap - used;
      p.freeSlots = free;
      if (cap === 0){
        if (used>0)      p.capStatus = 'over';
        else             p.capStatus = 'full';
      } else if (used < cap){
        p.capStatus = 'under';
      } else if (used === cap){
        p.capStatus = 'full';
      } else {
        p.capStatus = 'over';
      }
    });

    state.rawObjects = objs;
    state.people = people;
    state.managersByName = byName;

    // Show change log if there was previous data
    if (oldPeople.length > 0) {
      const changes = calculateChanges(oldPeople, people);
      if (hasChanges(changes)) {
        showChangeLogModal(changes);
      }
    }

    renderAll();
  }

  // --- Summary -----------------------------------------------------------
  function renderSummary(){
    const line = document.getElementById('summaryLine');
    const badges = document.getElementById('summaryBadges');
    const warnings = document.getElementById('summaryWarnings');
    const people = state.people || [];
    const total = people.length;
    const managerList = people.filter(p=>p.IsManager || p.currentReports>0);
    const managers = managerList.length;
    const under = managerList.filter(p=>p.capStatus==='under').length;
    const full = managerList.filter(p=>p.capStatus==='full').length;
    const over = managerList.filter(p=>p.capStatus==='over').length;

    line.innerHTML = `
      <span class="label">People:</span> <span class="value">${total}</span>
      <span class="dot">‚Ä¢</span>
      <span class="label">Managers:</span> <span class="value">${managers}</span>
    `;
    badges.innerHTML = `
      <div class="summary-badge"><span>Under capacity</span> <strong>${under}</strong></div>
      <div class="summary-badge"><span>At capacity</span> <strong>${full}</strong></div>
      <div class="summary-badge"><span>Over capacity</span> <strong>${over}</strong></div>
    `;

    // Detect data issues
    if (warnings && total > 0) {
      const issues = detectDataIssues(people);
      warnings.innerHTML = issues.map(issue => `
        <div class="summary-warning warning-${issue.type}">
          <span class="summary-warning-icon">${issue.type === 'error' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
          <div class="summary-warning-content">
            <div class="summary-warning-title">${issue.title} (${issue.items.length})</div>
            <div class="summary-warning-list">${issue.items.slice(0, 10).join(', ')}${issue.items.length > 10 ? `, +${issue.items.length - 10} more` : ''}</div>
          </div>
        </div>
      `).join('');
    } else if (warnings) {
      warnings.innerHTML = '';
    }
  }

  function detectDataIssues(people) {
    const issues = [];

    // Build set of all person keys
    const allKeys = new Set();
    people.forEach(p => {
      const key = canonicalName(p.FullName || p.Name);
      if (key) allKeys.add(key);
    });

    // Detect orphans (manager not in system)
    const orphans = [];
    people.forEach(p => {
      const managerName = p.Manager;
      if (managerName && managerName.trim()) {
        const managerKey = canonicalName(managerName);
        if (managerKey && !allKeys.has(managerKey)) {
          orphans.push(`${p.FullName || p.Name} ‚Üí ${managerName}`);
        }
      }
    });

    if (orphans.length > 0) {
      issues.push({
        type: 'error',
        title: 'Orphans (manager not in system)',
        items: orphans
      });
    }

    // Detect circular references
    const circular = [];
    people.forEach(p => {
      const personKey = canonicalName(p.FullName || p.Name);
      const visited = new Set();
      let current = p;
      let depth = 0;

      while (current && depth < 50) {
        const currentKey = canonicalName(current.FullName || current.Name);
        if (visited.has(currentKey)) {
          circular.push(p.FullName || p.Name);
          break;
        }
        visited.add(currentKey);

        const managerKey = canonicalName(current.Manager);
        if (!managerKey) break;

        current = people.find(m => canonicalName(m.FullName || m.Name) === managerKey);
        depth++;
      }
    });

    if (circular.length > 0) {
      issues.push({
        type: 'error',
        title: 'Circular reporting chains detected',
        items: [...new Set(circular)]
      });
    }

    return issues;
  }

  // --- People table ------------------------------------------------------
  const peopleHeadRow = document.getElementById('peopleHeadRow');
  const peopleBody = document.getElementById('peopleBody');
  const peopleSearch = document.getElementById('peopleSearch');

  function renderPeopleTable(){
    const people = state.people || [];
    const displayCols = [
      'FullName','Grade','GradeLevel','Discipline','Office',
      'Region','Area','DirectorName','Manager','IsManager','Capacity','currentReports'
    ];
    const headers = {
      FullName:'Name',
      Grade:'Grade',
      GradeLevel:'Grade level',
      Discipline:'Discipline',
      Office:'Office',
      Region:'Region',
      Area:'Area',
      DirectorName:'Director',
      Manager:'Manager',
      IsManager:'Is manager',
      Capacity:'Capacity',
      currentReports:'Reports'
    };
    peopleHeadRow.innerHTML = displayCols.map(c=>`<th>${headers[c]||c}</th>`).join('');
    const query = (peopleSearch.value||'').toString().trim().toLowerCase();
    const filtered = !query ? people : people.filter(p=>{
      const hay = [
        p.FullName,p.Grade,p.GradeLevel,p.Discipline,
        p.Office,p.Region,p.Area,p.Manager,p.DirectorName
      ].join(' ').toLowerCase();
      return hay.includes(query);
    });

    if (!filtered.length){
      peopleBody.innerHTML = `<tr><td colspan="${displayCols.length}" class="subtle">${people.length ? 'No matches for that search.' : 'Upload a CSV/XLSX to see people here.'}</td></tr>`;
      return;
    }

    // Build set of all person keys for orphan detection
    const allKeys = new Set();
    people.forEach(p => {
      const key = canonicalName(p.FullName || p.Name);
      if (key) allKeys.add(key);
    });

    peopleBody.innerHTML = filtered.map(p=>{
      const rowClasses = [];

      // Check if over capacity
      if (p.capStatus === 'over') {
        rowClasses.push('row-over-capacity');
      }

      // Check if orphan (manager not in system)
      const managerName = p.Manager;
      if (managerName && managerName.trim()) {
        const managerKey = canonicalName(managerName);
        if (managerKey && !allKeys.has(managerKey)) {
          rowClasses.push('row-orphan');
        }
      }

      return `
        <tr class="${rowClasses.join(' ')}">
          <td>${p.FullName || ''}</td>
          <td>${p.Grade || ''}</td>
          <td>${p.GradeLevel || ''}</td>
          <td>${p.Discipline || ''}</td>
          <td>${p.Office || ''}</td>
          <td>${p.Region || ''}</td>
          <td>${p.Area || ''}</td>
          <td>${p.DirectorName || ''}</td>
          <td>${p.Manager || ''}</td>
          <td>${p.IsManager || p.currentReports>0 ? 'Y' : 'N'}</td>
          <td>${capacityChip(p)}</td>
          <td>${p.currentReports}</td>
        </tr>
      `;
    }).join('');
  }

  peopleSearch.addEventListener('input', renderPeopleTable);

  // --- Find a manager ----------------------------------------------------
  const fmFreeCap = document.getElementById('fmFreeCap');
  const fmSearchBtn = document.getElementById('fmSearchBtn');
  const fmClearBtn = document.getElementById('fmClearBtn');
  const fmResults = document.getElementById('fmResults');

  let selectedRegions = [];
  let selectedOffices = [];
  let selectedGrades = [];
  const multiSelectOptions = { region: [], office: [], grade: [] };

  function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b)); }
  function getMultiSelect(filterKey){
    return document.querySelector(`.multi-select[data-filter="${filterKey}"]`);
  }
  function updateMultiSelectSummary(filterKey, selectedValues){
    const ms = getMultiSelect(filterKey);
    if (!ms) return;
    const summaryEl = ms.querySelector('.multi-select-summary');
    if (!summaryEl) return;
    if (!selectedValues || selectedValues.length === 0) {
      summaryEl.textContent = 'Any';
    } else if (selectedValues.length === 1) {
      summaryEl.textContent = selectedValues[0];
    } else {
      summaryEl.textContent = `${selectedValues[0]} +${selectedValues.length - 1}`;
    }
  }
  function resetMultiSelectSummary(filterKey){
    updateMultiSelectSummary(filterKey, []);
  }
  function getSelectedArray(filterKey){
    if (filterKey === 'region') return selectedRegions;
    if (filterKey === 'office') return selectedOffices;
    return selectedGrades;
  }
  function setSelectedArray(filterKey, values){
    if (filterKey === 'region') selectedRegions = values;
    else if (filterKey === 'office') selectedOffices = values;
    else selectedGrades = values;
  }
  function handleMultiSelectChange(filterKey, value, checked){
    const current = getSelectedArray(filterKey).slice();
    if (value === 'Any') {
      if (checked) current.length = 0;
    } else {
      if (checked) {
        if (!current.includes(value)) current.push(value);
      } else {
        const idx = current.indexOf(value);
        if (idx >= 0) current.splice(idx, 1);
      }
    }
    setSelectedArray(filterKey, current);
    updateMultiSelectSummary(filterKey, current);
    renderMultiSelectOptions(filterKey, multiSelectOptions[filterKey] || []);
    if (filterKey === 'region') {
      updateOfficeOptions();
    }
  }
  function renderMultiSelectOptions(filterKey, options){
    const ms = getMultiSelect(filterKey);
    if (!ms) return;
    const menu = ms.querySelector('.multi-select-menu');
    if (!menu) return;
    const selectedValues = getSelectedArray(filterKey);
    menu.innerHTML = '';

    const anyChecked = selectedValues.length === 0;
    const anyLabel = document.createElement('label');
    anyLabel.className = 'multi-select-option';
    const anyInput = document.createElement('input');
    anyInput.type = 'checkbox';
    anyInput.value = 'Any';
    anyInput.checked = anyChecked;
    anyInput.addEventListener('change', () => {
      handleMultiSelectChange(filterKey, anyInput.value, anyInput.checked);
    });
    const anyText = document.createElement('span');
    anyText.className = 'multi-select-option-label';
    anyText.textContent = 'Any';
    anyLabel.appendChild(anyInput);
    anyLabel.appendChild(anyText);
    menu.appendChild(anyLabel);

    options.forEach(optionValue => {
      const label = document.createElement('label');
      label.className = 'multi-select-option';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.value = optionValue;
      input.checked = selectedValues.includes(optionValue);
      input.addEventListener('change', () => {
        handleMultiSelectChange(filterKey, input.value, input.checked);
      });
      const text = document.createElement('span');
      text.className = 'multi-select-option-label';
      text.textContent = optionValue;
      label.appendChild(input);
      label.appendChild(text);
      menu.appendChild(label);
    });
  }
  function updateOfficeOptions(){
    const regionFilters = selectedRegions.length ? selectedRegions : ['Any'];
    const offices = getOfficesForRegion(regionFilters);
    multiSelectOptions.office = offices;
    selectedOffices = selectedOffices.filter(office => offices.includes(office));
    renderMultiSelectOptions('office', offices);
    updateMultiSelectSummary('office', selectedOffices);
  }
  function closeAllMultiSelects(){
    document.querySelectorAll('.multi-select.open').forEach(ms => ms.classList.remove('open'));
  }
  function setupMultiSelects(){
    document.querySelectorAll('.multi-select').forEach(ms => {
      const toggle = ms.querySelector('.multi-select-toggle');
      const menu = ms.querySelector('.multi-select-menu');
      if (toggle) {
        toggle.addEventListener('click', event => {
          event.stopPropagation();
          const isOpen = ms.classList.contains('open');
          closeAllMultiSelects();
          if (!isOpen) ms.classList.add('open');
        });
      }
      if (menu) {
        menu.addEventListener('click', event => event.stopPropagation());
      }
    });
    document.addEventListener('click', closeAllMultiSelects);
  }

  function fillFilterOptions(){
    const people = state.people || [];
    selectedRegions = [];
    selectedOffices = [];
    selectedGrades = [];
    multiSelectOptions.region = uniq(people.map(p=>p.Region));
    multiSelectOptions.grade = uniq(people.map(p=>p.Grade));
    renderMultiSelectOptions('region', multiSelectOptions.region);
    updateMultiSelectSummary('region', selectedRegions);
    renderMultiSelectOptions('grade', multiSelectOptions.grade);
    updateMultiSelectSummary('grade', selectedGrades);
    updateOfficeOptions();
    const hasData = people.length>0;
    fmSearchBtn.disabled = !hasData;
    fmClearBtn.disabled = !hasData;
  }

  function renderFindManagerResults(list){
    if (!list.length){
      fmResults.innerHTML = '<div class="subtle">No managers match those filters.</div>';
      return;
    }
    fmResults.innerHTML = list.map(p=>{
      return `
        <div class="manager-row">
          <div class="manager-main">
            <strong>${p.FullName}</strong>
            <div class="manager-meta">
              <span>${p.Grade || ''}</span>
              ${p.Discipline ? `<span>${p.Discipline}</span>` : ''}
              ${p.Office ? `<span>${p.Office}</span>` : ''}
              ${p.Region ? `<span>${p.Region}</span>` : ''}
            </div>
          </div>
          ${capacityChip(p,{showIfNonManager:true})}
        </div>
      `;
    }).join('');
  }

  setupMultiSelects();

  fmSearchBtn.addEventListener('click', ()=>{
    const people = state.people || [];
    const minFree = parseInt(fmFreeCap.value || '0', 10);
    const candidates = people.filter(p=>{
      const isManager = p.IsManager || p.currentReports>0;
      if (!isManager) return false;
      if (selectedRegions.length && !selectedRegions.includes(p.Region || '')) return false;
      if (selectedOffices.length && !selectedOffices.includes(p.Office || '')) return false;
      if (selectedGrades.length && !selectedGrades.includes(p.Grade || '')) return false;
      if ((p.freeSlots || 0) < minFree) return false;
      return true;
    }).sort((a,b)=>{
      const freeDiff = (b.freeSlots||0) - (a.freeSlots||0);
      if (freeDiff !== 0) return freeDiff;
      return a.FullName.localeCompare(b.FullName);
    });
    renderFindManagerResults(candidates);
  });

  fmClearBtn.addEventListener('click', ()=>{
    selectedRegions = [];
    selectedOffices = [];
    selectedGrades = [];
    renderMultiSelectOptions('region', multiSelectOptions.region);
    renderMultiSelectOptions('grade', multiSelectOptions.grade);
    updateOfficeOptions();
    resetMultiSelectSummary('region');
    resetMultiSelectSummary('office');
    resetMultiSelectSummary('grade');
    fmFreeCap.value = 1;
    fmResults.innerHTML = '<div class="subtle">Cleared. Set filters and click <strong>Suggest</strong>.</div>';
  });

  // --- Line managers by region -------------------------------------------
  const capacityRegionSelect = document.getElementById('capacity-region');
  const capacityOfficeSelect = document.getElementById('capacity-office');
  const capacityStatusSelect = document.getElementById('capacity-status');
  const capacityResults = document.getElementById('capacity-results');
  const capacitySearchBtn = document.getElementById('capacity-search');
  const capacityClearBtn = document.getElementById('capacity-clear');
  const capacityRecommendFor = document.getElementById('capacity-recommend-for');
  const capacityPersonList = document.getElementById('capacity-person-list');

  function populateCapacityPersonList(){
    if (!capacityPersonList) return;
    capacityPersonList.innerHTML = '';
    (state.people || []).forEach(p => {
      const name = p.FullName || p.Name || '';
      if (name) {
        const opt = document.createElement('option');
        opt.value = name;
        capacityPersonList.appendChild(opt);
      }
    });
  }

  function populateCapacityRegions(){
    if (!capacityRegionSelect) return;
    capacityRegionSelect.innerHTML = '<option value="Any">Any region</option>';
    const regions = new Set();
    (state.people || []).forEach(p=>{ if (p.Region) regions.add(p.Region); });
    Array.from(regions).sort().forEach(region=>{
      const opt = document.createElement('option');
      opt.value = region;
      opt.textContent = region;
      capacityRegionSelect.appendChild(opt);
    });
  }

  // Calculate weighted recommendation score for a manager relative to a person
  function calculateRecommendationScore(manager, targetPerson) {
    let score = 0;
    const reasons = [];

    // Capacity score (0-40 points) - most important
    const free = freeCapacity(manager);
    if (free > 0) {
      score += Math.min(40, free * 10);
      reasons.push(`${free} capacity available`);
    }

    // Same office bonus (25 points)
    if (targetPerson.Office && manager.Office === targetPerson.Office) {
      score += 25;
      reasons.push('Same office');
    }

    // Same region bonus (15 points) - only if not same office
    else if (targetPerson.Region && manager.Region === targetPerson.Region) {
      score += 15;
      reasons.push('Same region');
    }

    // Grade appropriateness bonus (up to 20 points)
    // Managers should ideally be 1-2 grades above the person
    const gradeOrder = ['Trainee', 'Graduate', 'Consultant', 'Senior Consultant', 'Associate Director', 'Director', 'Senior Director'];
    const targetGradeIdx = gradeOrder.findIndex(g => (targetPerson.Grade || '').includes(g));
    const managerGradeIdx = gradeOrder.findIndex(g => (manager.Grade || '').includes(g));

    if (targetGradeIdx >= 0 && managerGradeIdx >= 0) {
      const diff = managerGradeIdx - targetGradeIdx;
      if (diff >= 1 && diff <= 2) {
        score += 20;
        reasons.push('Appropriate grade level');
      } else if (diff >= 3 && diff <= 4) {
        score += 10;
        reasons.push('Senior manager');
      }
    }

    return { score, reasons };
  }

  function updateCapacityResults(){
    if (!capacityResults) return;

    const regionFilter = capacityRegionSelect ? capacityRegionSelect.value : 'Any';
    const statusFilter = capacityStatusSelect ? capacityStatusSelect.value : 'any';
    const officeFilter = capacityOfficeSelect ? capacityOfficeSelect.value : 'Any';
    const recommendForName = capacityRecommendFor ? capacityRecommendFor.value.trim() : '';

    // Find target person if specified
    let targetPerson = null;
    if (recommendForName) {
      const targetKey = canonicalName(recommendForName);
      targetPerson = (state.people || []).find(p => canonicalName(p.FullName || p.Name) === targetKey);
    }

    const managers = (state.people || []).filter(p => p.IsManager);

    // Exclude the target person from being their own manager
    const filtered = managers.filter(p => {
      if (targetPerson) {
        const pKey = canonicalName(p.FullName || p.Name);
        const targetKey = canonicalName(targetPerson.FullName || targetPerson.Name);
        if (pKey === targetKey) return false;
      }
      const regionOk = regionFilter === 'Any' || (p.Region || '') === regionFilter;
      const officeOk = officeFilter === 'Any' || (p.Office || '') === officeFilter;
      const statusOk = statusFilter === 'any' || (p.capStatus || '').toLowerCase() === statusFilter;
      return regionOk && officeOk && statusOk;
    });

    // Calculate scores if we have a target person
    let managersWithScores = filtered.map(p => {
      if (targetPerson) {
        const { score, reasons } = calculateRecommendationScore(p, targetPerson);
        return { manager: p, score, reasons };
      }
      return { manager: p, score: 0, reasons: [] };
    });

    // Sort by score (descending) if we have a target, otherwise by capacity
    if (targetPerson) {
      managersWithScores.sort((a, b) => b.score - a.score);
    } else {
      managersWithScores.sort((a, b) => {
        const status = statusFilter;
        if (status === 'over') {
          const deltaA = capacityDelta(a.manager);
          const deltaB = capacityDelta(b.manager);
          if (deltaA !== deltaB) return deltaB - deltaA;
        } else {
          const freeA = freeCapacity(a.manager);
          const freeB = freeCapacity(b.manager);
          if (freeA !== freeB) return freeB - freeA;
        }
        const regionCompare = (a.manager.Region || '').localeCompare(b.manager.Region || '');
        if (regionCompare !== 0) return regionCompare;
        return (a.manager.FullName || a.manager.Name || '').localeCompare(b.manager.FullName || b.manager.Name || '');
      });
    }

    capacityResults.innerHTML = '';

    if (!managersWithScores.length){
      capacityResults.innerHTML = '<p class="muted">No managers match these filters.</p>';
      return;
    }

    managersWithScores.forEach(({ manager: p, score, reasons }) => {
      const status = (p.capStatus || '').toLowerCase();
      const statusLabel = status === 'over' ? 'Over' : status === 'full' ? 'At' : 'Under';
      const row = document.createElement('div');
      row.className = 'manager-row';

      let scoreHtml = '';
      if (targetPerson && score > 0) {
        const scoreClass = score >= 60 ? 'high' : score >= 35 ? 'medium' : 'low';
        scoreHtml = `
          <div class="recommend-score">
            <span class="recommend-badge ${scoreClass}">Score: ${score}</span>
            <div class="recommend-reasons">${reasons.join(' ‚Ä¢ ')}</div>
          </div>
        `;
      }

      row.innerHTML = `
        <div class="manager-main">
          <strong>${p.FullName || p.Name}</strong>
          <span>${p.Grade || ''}</span>
          <span>${p.Office || ''}</span>
          <span>${p.Region || ''}</span>
        </div>
        ${scoreHtml}
        <div class="manager-cap">
          <span class="cap-chip ${status === 'over' ? 'cap-over' : status === 'full' ? 'cap-full' : 'cap-under'}">
            <span>${statusLabel}</span><strong>${p.currentReports || 0}/${p.Capacity || 0}</strong>
          </span>
        </div>
      `;
      capacityResults.appendChild(row);
    });
  }

  if (capacitySearchBtn){
    capacitySearchBtn.addEventListener('click', updateCapacityResults);
  }
  if (capacityClearBtn){
    capacityClearBtn.addEventListener('click', ()=>{
      if (capacityRecommendFor) capacityRecommendFor.value = '';
      if (capacityRegionSelect) capacityRegionSelect.value = 'Any';
      populateOfficeSelect(capacityOfficeSelect, 'Any');
      if (capacityOfficeSelect) capacityOfficeSelect.value = 'Any';
      if (capacityStatusSelect) capacityStatusSelect.value = 'any';
      if (capacityResults) capacityResults.innerHTML = '';
    });
  }

  if (capacityRegionSelect){
    capacityRegionSelect.addEventListener('change', ()=>{
      const region = capacityRegionSelect.value || 'Any';
      populateOfficeSelect(capacityOfficeSelect, region);
      if (capacityOfficeSelect) capacityOfficeSelect.value = 'Any';
    });
  }

  // --- Organigram --------------------------------------------------------
  const orgGroupBy = document.getElementById('orgGroupBy');
  const orgSubGroupField = document.getElementById('orgSubGroupField');
  const orgSubGroupSelect = document.getElementById('orgSubGroupSelect');
  const orgSubGroupLabel = document.getElementById('orgSubGroupLabel');
  const orgTreeRoot = document.getElementById('orgTreeRoot');
  const orgPersonSearchField = document.getElementById('orgPersonSearchField');
  const orgPersonSearch = document.getElementById('orgPersonSearch');
  const orgPersonList = document.getElementById('orgPersonList');
  const orgClearBtn = document.getElementById('orgClearBtn');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const zoomResetBtn = document.getElementById('zoomReset');
  const zoomLevelDisplay = document.getElementById('zoomLevel');
  const colorByCapacityCheckbox = document.getElementById('colorByCapacity');
  let orgZoomLevel = 1;
  const ZOOM_MIN = 0.5;
  const ZOOM_MAX = 2;
  const ZOOM_STEP = 0.1;
  let currentOrgView = 'overall'; // Track current view for external info

  // --- Helpers for the hierarchy view ---------------------------------------

  function canonicalName(name) {
    return (name || '').toString().trim().replace(/\s+/g, ' ').toLowerCase();
  }

  // Calculate total team size (direct + indirect reports)
  function getTotalTeamSize(personKey, allPeople, visited = new Set()) {
    if (!personKey || visited.has(personKey)) return 0;
    visited.add(personKey);

    let count = 0;
    allPeople.forEach(p => {
      const mgrKey = canonicalName(p.Manager);
      if (mgrKey === personKey) {
        count++; // Direct report
        const childKey = canonicalName(p.FullName || p.Name);
        count += getTotalTeamSize(childKey, allPeople, visited); // Indirect reports
      }
    });
    return count;
  }

  // Calculate team size in a specific group (region/office)
  function getTeamSizeInGroup(personKey, groupPeople, visited = new Set()) {
    if (!personKey || visited.has(personKey)) return 0;
    visited.add(personKey);

    let count = 0;
    groupPeople.forEach(p => {
      const mgrKey = canonicalName(p.Manager);
      if (mgrKey === personKey) {
        count++; // Direct report in this group
        const childKey = canonicalName(p.FullName || p.Name);
        count += getTeamSizeInGroup(childKey, groupPeople, visited); // Indirect reports
      }
    });
    return count;
  }

  function gradeIndex(grade) {
    const idx = GRADE_ORDER.indexOf((grade || '').trim());
    return idx === -1 ? GRADE_ORDER.length : idx;
  }

  function gradeDepthIndex(gradeName) {
    if (!gradeName) return 99;

    // Normalise case and spacing, and pad with spaces so
    // patterns like " director " or " cost manager " don't
    // accidentally match parts of other words.
    const normalised = ` ${gradeName.toLowerCase().replace(/\s+/g, ' ').trim()} `;

    // Rules are checked in this order. The FIRST match wins.
    const rules = [
      // Directors ‚Äì specific first
      { depth: 0, labels: ['senior director'] },
      { depth: 2, labels: ['project director'] },
      { depth: 3, labels: ['associate director'] },
      { depth: 1, labels: [' director '] }, // plain "Director"

      // Exec CM / QS
      { depth: 4, labels: ['executive cost manager', 'executive quantity surveyor'] },

      // Senior CM / QS
      { depth: 5, labels: ['senior cost manager', 'senior quantity surveyor'] },

      // Assistant / Graduate / Trainee CM / QS ‚Äì specific before generic
      { depth: 7, labels: ['assistant cost manager', 'assistant quantity surveyor'] },
      { depth: 8, labels: ['graduate cost manager', 'graduate quantity surveyor'] },
      { depth: 9, labels: ['trainee cost manager', 'trainee quantity surveyor'] },

      // Generic Cost Manager / QS (checked last so it doesn't swallow the others)
      { depth: 6, labels: [' cost manager ', ' quantity surveyor '] },
    ];

    for (let i = 0; i < rules.length; i++) {
      const rule = rules[i];
      for (let j = 0; j < rule.labels.length; j++) {
        if (normalised.includes(rule.labels[j])) {
          return rule.depth;
        }
      }
    }

    // Unknown / non-standard grades go to the bottom
    return 99;
  }

  function getPersonNameKey(person) {
    if (!person) return '';

    const raw =
      person.Name ||
      person['Full name'] ||
      person['Full Name'] ||
      person['Employee'] ||
      person['Employee name'] ||
      person.name ||
      '';

    return canonicalName(raw);
  }

  function clearOrgHighlightsInGroup(groupRoot) {
    if (!groupRoot) return;
    const cards = groupRoot.querySelectorAll('.org-person-card');
    cards.forEach(card => {
      card.classList.remove('org-highlight-manager', 'org-highlight-report');
    });
  }

  function onOrgPersonCardClick(evt) {
    const card = evt.currentTarget;
    const groupKey = card.dataset.groupKey;
    const personKey = (card.dataset.personKey || '').toLowerCase();

    if (!groupKey || !personKey) return;
    const treeInfo = state.orgTreesByGroup && state.orgTreesByGroup[groupKey];
    if (!treeInfo) return;

    const node = treeInfo.nodeByName.get(personKey);
    if (!node) return;

    const container = card.closest('.org-tree-container');
    if (!container) return;

    const svg = container.querySelector('.org-tree-svg');

    // Clear all previous highlights
    container.querySelectorAll('.org-person-card.org-highlight-selected, .org-person-card.org-highlight-manager, .org-person-card.org-highlight-report')
      .forEach(el => el.classList.remove('org-highlight-selected', 'org-highlight-manager', 'org-highlight-report'));

    // Clear all line highlights
    if (svg) {
      svg.querySelectorAll('.org-connection-line')
        .forEach(line => line.classList.remove('show-manager', 'show-report'));
    }

    // Highlight the clicked person
    card.classList.add('org-highlight-selected');

    // Find and highlight their manager
    const managerKey = node.managerKey;
    if (managerKey) {
      const managerNode = treeInfo.nodeByName.get(managerKey);
      if (managerNode) {
        const managerCard = container.querySelector(`.org-person-card[data-person-key="${managerKey}"]`);
        if (managerCard) {
          managerCard.classList.add('org-highlight-manager');
        }
        // Highlight the line to manager
        if (svg) {
          const managerLine = svg.querySelector(`.org-connection-line[data-child="${personKey}"]`);
          if (managerLine) {
            managerLine.classList.add('show-manager');
          }
        }
      }
    }

    // Find and highlight direct reports
    (node.children || []).forEach(child => {
      const cp = child.person || child.raw || {};
      const childRaw = cp.FullName || cp.Name || cp['Full name'] || cp['Full Name'] || cp['Employee name'] || cp['Employee'] || cp.name || '';
      const childKey = canonicalName(childRaw);
      if (!childKey) return;

      const childCard = container.querySelector(`.org-person-card[data-person-key="${childKey}"]`);
      if (childCard) {
        childCard.classList.add('org-highlight-report');
      }
      // Highlight the line to this report
      if (svg) {
        const reportLine = svg.querySelector(`.org-connection-line[data-child="${childKey}"]`);
        if (reportLine) {
          reportLine.classList.add('show-report');
        }
      }
    });

    // Show info about relationships outside this group
    const person = node.person || {};
    showExternalRelationshipsInfo(person, groupKey);
  }

  function createOrgTreeCard(node, groupKey, groupPeople, groupLabel) {
    const person = node.person || node.raw || {};
    const card = document.createElement('div');
    card.className = 'org-card org-person-card';
    card.style.cursor = 'pointer';

    const rawName =
      person.FullName ||
      person.Name ||
      person['Full name'] ||
      person['Full Name'] ||
      person['Employee name'] ||
      person['Employee'] ||
      person.name ||
      '';
    const personKey = node.personKey || canonicalName(rawName);
    card.dataset.personKey = personKey || '';
    card.dataset.groupKey = groupKey || '';
    card.addEventListener('click', onOrgPersonCardClick);

    const status = (person.capStatus || '').toLowerCase();
    const statusLabel = status === 'over' ? 'Over' : status === 'full' ? 'At' : 'Under';
    const capCls = status === 'over' ? 'cap-chip cap-over' : status === 'full' ? 'cap-chip cap-full' : 'cap-chip cap-under';

    // Highlight over-capacity managers
    if (status === 'over') {
      card.classList.add('org-over-capacity');
    }

    // Add capacity status class for color mode
    card.classList.add(`cap-status-${status || 'under'}`);

    // Calculate team size in current group
    const peopleInGroup = groupPeople || state.people || [];
    const teamInGroup = getTeamSizeInGroup(personKey, peopleInGroup);
    const displayLabel = groupLabel && groupLabel !== 'Overall' ? groupLabel : '';

    let teamBadgeHtml = '';
    if (teamInGroup > 0) {
      const labelText = displayLabel ? `Team in ${displayLabel}:` : 'Team:';
      teamBadgeHtml = `<div class="org-team-badge">${labelText} <span class="team-count">${teamInGroup}</span></div>`;
    }

    card.innerHTML = `
      <div class="org-name">${person.FullName || person.Name || ''}</div>
      <div class="org-meta">${[person.Grade || '', person.Office || ''].filter(Boolean).join(' ‚Ä¢ ')}</div>
      <div class="org-cap">
        <span class="${capCls}"><span>${statusLabel}</span><strong>${person.currentReports || 0}/${person.Capacity || 0}</strong></span>
      </div>
      ${teamBadgeHtml}
    `;

    return card;
  }

  function buildOrganigramGroups(){
    const mode = orgGroupBy ? orgGroupBy.value : 'region';
    const people = state.people || [];
    const groups = new Map();

    if (mode === 'overall') {
      const key = 'overall';
      groups.set(key, { key, label: 'All people', people: people.slice() });
    } else if (mode === 'region') {
      people.forEach(p => {
        const key = p.Region || 'Unspecified';
        if (!groups.has(key)) groups.set(key, { key, label: key, people: [] });
        groups.get(key).people.push(p);
      });
    } else if (mode === 'office') {
      people.forEach(p => {
        const key = p.Office || 'Unspecified';
        if (!groups.has(key)) groups.set(key, { key, label: key, people: [] });
        groups.get(key).people.push(p);
      });
    }

    return Array.from(groups.values()).sort((a,b)=> a.label.localeCompare(b.label));
  }

  function buildHierarchyForGroup(groupPeople){
    const nodes = groupPeople.map(p => ({
      person: p,
      key: canonicalName(p.FullName || p.Name),
      managerKey: canonicalName(p.Manager),
      children: [],
      depth: 0,
    }));

    const byKey = new Map();
    nodes.forEach(n => { if (n.key) byKey.set(n.key, n); });

    nodes.forEach(node => {
      const mgr = node.managerKey && byKey.get(node.managerKey);
      if (mgr && mgr !== node) mgr.children.push(node);
    });

    const roots = nodes.filter(node => {
      const mgr = node.managerKey && byKey.get(node.managerKey);
      return !mgr || mgr === node;
    });

    const queue = [];
    const visited = new Set();
    roots.forEach(root => { root.depth = 0; queue.push(root); visited.add(root); });

    while(queue.length){
      const current = queue.shift();
      current.children.forEach(child => {
        if (!visited.has(child)){
          child.depth = current.depth + 1;
          visited.add(child);
          queue.push(child);
        }
      });
    }

    nodes.forEach(node => {
      if (!visited.has(node)){
        node.depth = 0;
        roots.push(node);
      }
    });

    nodes.forEach(node => {
      node.depth = gradeDepthIndex(node.person.Grade || node.person.GradeLevel || '');
    });

    return { nodes, roots };
  }

  function renderOrgTree(groupKey){
    const detail = document.getElementById('org-tree-detail');
    if (!detail) return;

    const groups = buildOrganigramGroups();
    const group = groups.find(g => g.key === groupKey);
    if (!group){
      detail.innerHTML = '<p class="subtle">No data for this group.</p>';
      return;
    }

    const { nodes, roots } = buildHierarchyForGroup(group.people);

    const nodeByName = new Map();
    nodes.forEach(node => {
      const person = node.person || node.raw || {};
      const rawName =
        person.FullName ||
        person.Name ||
        person['Full name'] ||
        person['Full Name'] ||
        person['Employee name'] ||
        person['Employee'] ||
        person.name ||
        '';

      const key = canonicalName(rawName);
      if (key) {
        nodeByName.set(key, node);
        node.personKey = key;
      }
    });

    if (!window.state) window.state = {};
    if (!state.orgTreesByGroup) state.orgTreesByGroup = {};
    state.orgTreesByGroup[groupKey] = { nodes, roots, nodeByName };

    const levels = new Map();
    let maxDepth = 0;
    nodes.forEach(n => {
      const d = n.depth || 0;
      if (!levels.has(d)) levels.set(d, []);
      levels.get(d).push(n);
      if (d > maxDepth) maxDepth = d;
    });

    levels.forEach(levelNodes => {
      levelNodes.sort((a,b)=>{
        const ga = gradeIndex(a.person.Grade);
        const gb = gradeIndex(b.person.Grade);
        if (ga !== gb) return ga - gb;
        return (a.person.FullName || a.person.Name || '').localeCompare(b.person.FullName || b.person.Name || '');
      });
    });

    detail.innerHTML = '';
    const title = document.createElement('h3');
    title.textContent = `${group.label} ‚Äì Hierarchy`;
    detail.appendChild(title);

    if (!nodes.length){
      detail.innerHTML += '<div class="subtle">No people in this group.</div>';
      return;
    }

    // Add legend
    const legend = document.createElement('div');
    legend.className = 'org-legend';
    legend.innerHTML = `
      <span class="subtle">Click a person to see relationships:</span>
      <div class="org-legend-item"><div class="org-legend-color selected"></div> Selected</div>
      <div class="org-legend-item"><div class="org-legend-color manager"></div> Their Manager</div>
      <div class="org-legend-item"><div class="org-legend-color report"></div> Their Reports</div>
    `;
    detail.appendChild(legend);

    // Create tree container with SVG layer
    const treeContainer = document.createElement('div');
    treeContainer.className = 'org-tree-container';

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'org-tree-svg');
    treeContainer.appendChild(svg);

    const treeContent = document.createElement('div');
    treeContent.className = 'org-tree-content';

    const groupContainer = document.createElement('div');
    groupContainer.className = 'org-group org-tree';
    groupContainer.setAttribute('data-group-key', groupKey);

    // Grade level labels
    const gradeLevelLabels = {
      0: 'Senior Director',
      1: 'Director',
      2: 'Project Director',
      3: 'Associate Director',
      4: 'Executive Cost Manager',
      5: 'Senior Cost Manager',
      6: 'Cost Manager',
      7: 'Assistant Cost Manager',
      8: 'Graduate Cost Manager',
      9: 'Trainee Cost Manager'
    };

    for (let depth = 0; depth <= maxDepth; depth++){
      const levelNodes = levels.get(depth) || [];
      if (!levelNodes.length) continue;

      const section = document.createElement('div');
      section.className = 'org-level-section';

      const label = document.createElement('div');
      label.className = 'org-level-label';
      label.textContent = gradeLevelLabels[depth] || `Level ${depth}`;
      section.appendChild(label);

      const row = document.createElement('div');
      row.className = 'org-level-row';
      levelNodes.forEach(node => {
        row.appendChild(createOrgTreeCard(node, groupKey, group.people, group.label));
      });
      section.appendChild(row);
      groupContainer.appendChild(section);
    }

    treeContent.appendChild(groupContainer);
    treeContainer.appendChild(treeContent);
    detail.appendChild(treeContainer);

    // Draw connection lines after DOM is rendered
    requestAnimationFrame(() => {
      drawConnectionLines(treeContainer, svg, nodes, nodeByName);
    });
  }

  function drawConnectionLines(container, svg, nodes, nodeByName) {
    const containerRect = container.getBoundingClientRect();

    // Set SVG size to match container
    svg.setAttribute('width', container.scrollWidth);
    svg.setAttribute('height', container.scrollHeight);
    svg.innerHTML = '';

    nodes.forEach(node => {
      const person = node.person || {};
      const managerKey = node.managerKey;

      if (!managerKey) return;

      const managerNode = nodeByName.get(managerKey);
      if (!managerNode) return;

      // Find the card elements
      const childCard = container.querySelector(`.org-person-card[data-person-key="${node.personKey}"]`);
      const parentCard = container.querySelector(`.org-person-card[data-person-key="${managerNode.personKey}"]`);

      if (!childCard || !parentCard) return;

      const childRect = childCard.getBoundingClientRect();
      const parentRect = parentCard.getBoundingClientRect();

      // Calculate positions relative to container
      const childCenterX = childRect.left - containerRect.left + childRect.width / 2;
      const childTopY = childRect.top - containerRect.top;
      const parentCenterX = parentRect.left - containerRect.left + parentRect.width / 2;
      const parentBottomY = parentRect.top - containerRect.top + parentRect.height;

      // Draw step-line path
      const midY = parentBottomY + (childTopY - parentBottomY) / 2;

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const d = `M ${parentCenterX} ${parentBottomY} L ${parentCenterX} ${midY} L ${childCenterX} ${midY} L ${childCenterX} ${childTopY}`;
      path.setAttribute('d', d);
      path.setAttribute('class', 'org-connection-line');
      path.setAttribute('data-parent', managerNode.personKey);
      path.setAttribute('data-child', node.personKey);
      svg.appendChild(path);
    });
  }

  // Render tree directly to orgTreeRoot (for auto-build)
  function renderOrgTreeDirect(groupKey, groupLabel, groupPeople) {
    orgTreeRoot.innerHTML = '';

    if (!groupPeople || !groupPeople.length) {
      orgTreeRoot.innerHTML = '<div class="subtle">No people in this group.</div>';
      return;
    }

    const { nodes, roots } = buildHierarchyForGroup(groupPeople);

    const nodeByName = new Map();
    nodes.forEach(node => {
      const person = node.person || {};
      const rawName = person.FullName || person.Name || '';
      const key = canonicalName(rawName);
      if (key) {
        nodeByName.set(key, node);
        node.personKey = key;
      }
    });

    if (!state.orgTreesByGroup) state.orgTreesByGroup = {};
    state.orgTreesByGroup[groupKey] = { nodes, roots, nodeByName, groupLabel };

    const levels = new Map();
    let maxDepth = 0;
    nodes.forEach(n => {
      const d = n.depth || 0;
      if (!levels.has(d)) levels.set(d, []);
      levels.get(d).push(n);
      if (d > maxDepth) maxDepth = d;
    });

    levels.forEach(levelNodes => {
      levelNodes.sort((a, b) => {
        const ga = gradeIndex(a.person.Grade);
        const gb = gradeIndex(b.person.Grade);
        if (ga !== gb) return ga - gb;
        return (a.person.FullName || '').localeCompare(b.person.FullName || '');
      });
    });

    // Add legend
    const legend = document.createElement('div');
    legend.className = 'org-legend';
    legend.innerHTML = `
      <span class="subtle">Click a person to see relationships:</span>
      <div class="org-legend-item"><div class="org-legend-color selected"></div> Selected</div>
      <div class="org-legend-item"><div class="org-legend-color manager"></div> Their Manager</div>
      <div class="org-legend-item"><div class="org-legend-color report"></div> Their Reports</div>
    `;
    orgTreeRoot.appendChild(legend);

    // Create tree container
    const treeContainer = document.createElement('div');
    treeContainer.className = 'org-tree-container';

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'org-tree-svg');
    treeContainer.appendChild(svg);

    const treeContent = document.createElement('div');
    treeContent.className = 'org-tree-content';

    const groupContainer = document.createElement('div');
    groupContainer.className = 'org-group org-tree';
    groupContainer.setAttribute('data-group-key', groupKey);

    const gradeLevelLabels = {
      0: 'Senior Director',
      1: 'Director',
      2: 'Project Director',
      3: 'Associate Director',
      4: 'Executive Cost Manager',
      5: 'Senior Cost Manager',
      6: 'Cost Manager',
      7: 'Assistant Cost Manager',
      8: 'Graduate Cost Manager',
      9: 'Trainee Cost Manager'
    };

    for (let depth = 0; depth <= maxDepth; depth++) {
      const levelNodes = levels.get(depth) || [];
      if (!levelNodes.length) continue;

      const section = document.createElement('div');
      section.className = 'org-level-section';

      const label = document.createElement('div');
      label.className = 'org-level-label';
      label.textContent = gradeLevelLabels[depth] || `Level ${depth}`;
      section.appendChild(label);

      const row = document.createElement('div');
      row.className = 'org-level-row';
      levelNodes.forEach(node => {
        row.appendChild(createOrgTreeCard(node, groupKey, groupPeople, groupLabel));
      });
      section.appendChild(row);
      groupContainer.appendChild(section);
    }

    treeContent.appendChild(groupContainer);
    treeContainer.appendChild(treeContent);
    orgTreeRoot.appendChild(treeContainer);

    // Draw connection lines
    requestAnimationFrame(() => {
      drawConnectionLines(treeContainer, svg, nodes, nodeByName);
    });
  }

  // Show info about out-of-group relationships
  function showExternalRelationshipsInfo(person, groupKey) {
    // Remove any existing info box
    const existing = document.querySelector('.org-external-info');
    if (existing) existing.remove();

    const allPeople = state.people || [];
    const treeInfo = state.orgTreesByGroup && state.orgTreesByGroup[groupKey];
    if (!treeInfo) return;

    const messages = [];

    // Check if manager is outside this group
    const managerKey = canonicalName(person.Manager);
    if (managerKey) {
      const managerInGroup = treeInfo.nodeByName.get(managerKey);
      if (!managerInGroup) {
        // Find manager in all people
        const manager = allPeople.find(p => canonicalName(p.FullName || p.Name) === managerKey);
        if (manager) {
          const locationParts = [manager.Office, manager.Region].filter(Boolean);
          const location = locationParts.length > 0 ? locationParts.join(', ') : 'another location';
          messages.push({
            type: 'manager',
            text: `Manager: ${manager.FullName || manager.Name} (${location})`
          });
        }
      }
    }

    // Check for reports outside this group
    const personKey = canonicalName(person.FullName || person.Name);
    const externalReports = allPeople.filter(p => {
      const theirManagerKey = canonicalName(p.Manager);
      if (theirManagerKey !== personKey) return false;
      // Check if they're in the current group
      const inGroup = treeInfo.nodeByName.get(canonicalName(p.FullName || p.Name));
      return !inGroup;
    });

    if (externalReports.length > 0) {
      const locations = new Set();
      externalReports.forEach(r => {
        const loc = [r.Office, r.Region].filter(Boolean).join(', ');
        if (loc) locations.add(loc);
      });
      const locStr = locations.size > 0 ? Array.from(locations).join('; ') : 'other locations';
      messages.push({
        type: 'reports',
        text: `${externalReports.length} report${externalReports.length > 1 ? 's' : ''} in ${locStr}`
      });
    }

    if (messages.length === 0) return;

    // Create info box
    const infoBox = document.createElement('div');
    infoBox.className = 'org-external-info';
    infoBox.innerHTML = `
      <button class="org-external-close" onclick="this.parentElement.remove()">√ó</button>
      <div class="org-external-info-title">${person.FullName || person.Name}</div>
      ${messages.map(m => `
        <div class="org-external-info-item">
          <span class="badge ${m.type}">${m.type === 'manager' ? '‚Üë Manager' : '‚Üì Reports'}</span>
          ${m.text}
        </div>
      `).join('')}
    `;
    document.body.appendChild(infoBox);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (infoBox.parentElement) infoBox.remove();
    }, 5000);
  }

  function renderOrganigram(){
    const people = state.people || [];
    if (!people.length){
      orgTreeRoot.innerHTML = '<div class="subtle">Upload a file on the Overview tab and click <strong>Build organigram</strong> to see the structure.</div>';
      return;
    }

    state.orgTreesByGroup = {};

    const groups = buildOrganigramGroups();
    orgTreeRoot.innerHTML = '';

    const listContainer = document.createElement('div');
    listContainer.id = 'org-group-list';

    groups.forEach(group => {
      const managers = group.people.filter(p => p.IsManager || p.currentReports > 0);
      const row = document.createElement('div');
      row.className = 'org-group-row';
      row.innerHTML = `
        <div class="org-group-label">
          <strong>${group.label}</strong>
          <span>${group.people.length} people ‚Ä¢ ${managers.length} managers</span>
        </div>
        <div class="org-group-actions">
          <button class="btn btn-ghost org-view-tree" data-group="${group.key}">View tree</button>
        </div>
      `;
      listContainer.appendChild(row);
    });

    orgTreeRoot.appendChild(listContainer);

    const detail = document.createElement('div');
    detail.id = 'org-tree-detail';
    detail.className = 'org-tree-detail';
    detail.innerHTML = '<div class="subtle">Select a group to view its hierarchy.</div>';
    orgTreeRoot.appendChild(detail);

    listContainer.addEventListener('click', e => {
      const btn = e.target.closest('.org-view-tree');
      if (!btn) return;
      const key = btn.getAttribute('data-group');
      renderOrgTree(key);
    });

    if (!groups.length){
      orgTreeRoot.innerHTML = '<div class="subtle">Nothing to display.</div>';
    }
  }

  function buildOrgTreeForRegion(peopleInRegion) {
    // Create a node for every person in this region
    const nodes = peopleInRegion.map(p => ({
      person: p,
      key: canonicalName(p.FullName || p.Name),
      managerKey: canonicalName(p.Manager),
      children: [],
      depth: 0,
      x: 0,
      y: 0,
      boxWidth: 0,
      boxHeight: 0,
    }));

    const byKey = new Map();
    nodes.forEach(n => {
      if (n.key) byKey.set(n.key, n);
    });

    // Link children to managers (within this region only)
    nodes.forEach(node => {
      const mgr = node.managerKey && byKey.get(node.managerKey);
      if (mgr && mgr !== node) {
        mgr.children.push(node);
      }
    });

    // Roots: people whose manager is not in this region (or blank/self)
    const roots = nodes.filter(node => {
      const mgr = node.managerKey && byKey.get(node.managerKey);
      return !mgr || mgr === node;
    });

    // Assign depth via BFS from all roots
    const queue = [];
    const visited = new Set();

    roots.forEach(root => {
      root.depth = 0;
      queue.push(root);
      visited.add(root);
    });

    while (queue.length) {
      const current = queue.shift();
      current.children.forEach(child => {
        if (!visited.has(child)) {
          child.depth = current.depth + 1;
          visited.add(child);
          queue.push(child);
        }
      });
    }

    // Any unvisited nodes (broken manager chain) become additional roots at depth 0
    nodes.forEach(node => {
      if (!visited.has(node)) {
        node.depth = 0;
        roots.push(node);
      }
    });

    return { nodes, roots };
  }

  function layoutOrgTree(nodes) {
    // Group nodes by depth
    const levels = new Map();
    let maxDepth = 0;

    nodes.forEach(node => {
      const d = node.depth || 0;
      if (!levels.has(d)) levels.set(d, []);
      levels.get(d).push(node);
      if (d > maxDepth) maxDepth = d;
    });

    // Order peers within a level by grade then name
    levels.forEach(levelNodes => {
      levelNodes.sort((a, b) => {
        const ga = gradeIndex(a.person.Grade);
        const gb = gradeIndex(b.person.Grade);
        if (ga !== gb) return ga - gb;
        return (a.person.FullName || a.person.Name || '')
          .localeCompare(b.person.FullName || b.person.Name || '');
      });
    });

    const slideWidth = 10;      // inches
    const leftMargin = 0.5;
    const rightMargin = 0.5;
    const availableWidth = slideWidth - leftMargin - rightMargin;

    const defaultBoxWidth = 2.5;
    const boxHeight = 0.6;
    const topMargin = 1.2;
    const levelGap = 1.3;

    for (let depth = 0; depth <= maxDepth; depth++) {
      const levelNodes = levels.get(depth) || [];
      if (!levelNodes.length) continue;

      const count = levelNodes.length;
      const step = availableWidth / count;

      // Ensure boxes fit inside the step (no overlap)
      const boxWidth = Math.min(defaultBoxWidth, step - 0.15);

      levelNodes.forEach((node, index) => {
        const xStart = leftMargin + step * index;
        node.boxWidth = boxWidth;
        node.boxHeight = boxHeight;
        node.x = xStart + (step - boxWidth) / 2;
        node.y = topMargin + depth * levelGap;
      });
    }
  }

  // Organigram view change handler
  function onOrgGroupByChange() {
    const mode = orgGroupBy.value;
    currentOrgView = mode;

    // Reset zoom when view changes
    orgZoomLevel = 1;
    applyOrgZoom();

    // Hide all optional fields first
    if (orgSubGroupField) orgSubGroupField.style.display = 'none';
    if (orgPersonSearchField) orgPersonSearchField.style.display = 'none';

    if (mode === 'overall') {
      buildOrganigramForGroup('overall');
    } else if (mode === 'person') {
      // Show person search
      if (orgPersonSearchField) orgPersonSearchField.style.display = 'block';
      populatePersonList();
      orgTreeRoot.innerHTML = '<div class="subtle">Type a name to see their full reporting chain (managers above, reports below).</div>';
    } else {
      // Show sub-group selector and populate it
      if (orgSubGroupField) orgSubGroupField.style.display = 'block';
      if (orgSubGroupLabel) orgSubGroupLabel.textContent = mode === 'region' ? 'Region' : 'Office';
      populateSubGroupSelect(mode);
    }
  }

  function populatePersonList() {
    if (!orgPersonList) return;
    const people = state.people || [];
    orgPersonList.innerHTML = '';
    people.forEach(p => {
      const name = p.FullName || p.Name || '';
      if (name) {
        const opt = document.createElement('option');
        opt.value = name;
        orgPersonList.appendChild(opt);
      }
    });
  }

  function onPersonSearchChange() {
    const searchVal = (orgPersonSearch.value || '').trim();
    if (!searchVal) return;

    const people = state.people || [];
    const person = people.find(p => {
      const name = (p.FullName || p.Name || '').toLowerCase();
      return name === searchVal.toLowerCase();
    });

    if (person) {
      buildPersonHierarchyTree(person);
    }
  }

  function buildPersonHierarchyTree(targetPerson) {
    const people = state.people || [];
    const targetKey = canonicalName(targetPerson.FullName || targetPerson.Name);

    // Build a map of all people by key
    const byKey = new Map();
    people.forEach(p => {
      const key = canonicalName(p.FullName || p.Name);
      if (key) byKey.set(key, p);
    });

    // Find all ancestors (managers up the chain)
    const ancestors = [];
    let current = targetPerson;
    while (current) {
      const managerKey = canonicalName(current.Manager);
      if (!managerKey) break;
      const manager = byKey.get(managerKey);
      if (!manager || ancestors.includes(manager)) break; // Prevent infinite loop
      ancestors.unshift(manager); // Add to beginning
      current = manager;
    }

    // Find all descendants (reports down the chain) recursively
    function getDescendants(person, visited = new Set()) {
      const personKey = canonicalName(person.FullName || person.Name);
      if (visited.has(personKey)) return [];
      visited.add(personKey);

      const directReports = people.filter(p => {
        const mgrKey = canonicalName(p.Manager);
        return mgrKey === personKey;
      });

      const result = [];
      directReports.forEach(report => {
        result.push({ person: report, depth: 1 });
        const subReports = getDescendants(report, visited);
        subReports.forEach(sr => {
          result.push({ person: sr.person, depth: sr.depth + 1 });
        });
      });
      return result;
    }

    const descendants = getDescendants(targetPerson);

    // Build the focused tree data
    const treeData = [];

    // Add ancestors
    ancestors.forEach((p, idx) => {
      treeData.push({
        person: p,
        level: idx,
        isTarget: false,
        isAncestor: true,
        isDescendant: false
      });
    });

    // Add target person
    treeData.push({
      person: targetPerson,
      level: ancestors.length,
      isTarget: true,
      isAncestor: false,
      isDescendant: false
    });

    // Add descendants
    descendants.forEach(d => {
      treeData.push({
        person: d.person,
        level: ancestors.length + d.depth,
        isTarget: false,
        isAncestor: false,
        isDescendant: true
      });
    });

    // Render the focused tree
    renderPersonHierarchyTree(targetPerson, treeData, ancestors.length);
  }

  function renderPersonHierarchyTree(targetPerson, treeData, targetLevel) {
    orgTreeRoot.innerHTML = '';

    const targetName = targetPerson.FullName || targetPerson.Name;

    // Add legend
    const legend = document.createElement('div');
    legend.className = 'org-legend';
    legend.innerHTML = `
      <span class="subtle">Showing hierarchy for <strong>${targetName}</strong>:</span>
      <div class="org-legend-item"><div class="org-legend-color manager"></div> Managers (above)</div>
      <div class="org-legend-item"><div class="org-legend-color selected"></div> Selected Person</div>
      <div class="org-legend-item"><div class="org-legend-color report"></div> Reports (below)</div>
    `;
    orgTreeRoot.appendChild(legend);

    if (treeData.length === 0) {
      orgTreeRoot.innerHTML += '<div class="subtle">No hierarchy data found for this person.</div>';
      return;
    }

    // Group by level
    const levels = new Map();
    let maxLevel = 0;
    treeData.forEach(d => {
      if (!levels.has(d.level)) levels.set(d.level, []);
      levels.get(d.level).push(d);
      if (d.level > maxLevel) maxLevel = d.level;
    });

    // Create container
    const treeContainer = document.createElement('div');
    treeContainer.className = 'org-tree-container';

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'org-tree-svg');
    treeContainer.appendChild(svg);

    const treeContent = document.createElement('div');
    treeContent.className = 'org-tree-content';

    const groupContainer = document.createElement('div');
    groupContainer.className = 'org-group org-tree';
    groupContainer.setAttribute('data-group-key', 'person-tree');

    // Build hierarchy for connection lines
    const nodes = [];
    const nodeByName = new Map();

    for (let level = 0; level <= maxLevel; level++) {
      const levelData = levels.get(level) || [];
      if (!levelData.length) continue;

      const section = document.createElement('div');
      section.className = 'org-level-section';

      const labelText = level < targetLevel ? 'Management Chain' :
                        level === targetLevel ? 'Selected Person' : 'Direct & Indirect Reports';

      const label = document.createElement('div');
      label.className = 'org-level-label';
      label.textContent = levelText(level, targetLevel, levelData.length);
      section.appendChild(label);

      const row = document.createElement('div');
      row.className = 'org-level-row';

      levelData.forEach(d => {
        const node = {
          person: d.person,
          key: canonicalName(d.person.FullName || d.person.Name),
          managerKey: canonicalName(d.person.Manager),
          personKey: canonicalName(d.person.FullName || d.person.Name),
          children: [],
          depth: level
        };
        nodes.push(node);
        nodeByName.set(node.key, node);

        const card = createPersonTreeCard(d, 'person-tree');
        row.appendChild(card);
      });

      section.appendChild(row);
      groupContainer.appendChild(section);
    }

    // Link children for connection lines
    nodes.forEach(node => {
      if (node.managerKey) {
        const parent = nodeByName.get(node.managerKey);
        if (parent) parent.children.push(node);
      }
    });

    // Store for click handling
    state.orgTreesByGroup = state.orgTreesByGroup || {};
    state.orgTreesByGroup['person-tree'] = { nodes, roots: [], nodeByName };

    treeContent.appendChild(groupContainer);
    treeContainer.appendChild(treeContent);
    orgTreeRoot.appendChild(treeContainer);

    // Draw connection lines
    requestAnimationFrame(() => {
      drawConnectionLines(treeContainer, svg, nodes, nodeByName);
      // Show all lines for person tree
      svg.querySelectorAll('.org-connection-line').forEach(line => {
        line.style.opacity = '0.4';
      });
    });
  }

  function levelText(level, targetLevel, count) {
    if (level < targetLevel) {
      const diff = targetLevel - level;
      if (diff === 1) return 'Direct Manager';
      return `Manager (+${diff} levels up)`;
    } else if (level === targetLevel) {
      return 'Selected Person';
    } else {
      const diff = level - targetLevel;
      if (diff === 1) return `Direct Reports (${count})`;
      return `Reports (+${diff} levels down) (${count})`;
    }
  }

  function createPersonTreeCard(data, groupKey) {
    const person = data.person;
    const card = document.createElement('div');
    card.className = 'org-card org-person-card';
    card.style.cursor = 'pointer';

    const personKey = canonicalName(person.FullName || person.Name);
    card.dataset.personKey = personKey;
    card.dataset.groupKey = groupKey;

    // Apply highlighting based on role
    if (data.isTarget) {
      card.classList.add('org-highlight-selected');
    } else if (data.isAncestor) {
      card.classList.add('org-highlight-manager');
    } else if (data.isDescendant) {
      card.classList.add('org-highlight-report');
    }

    const status = (person.capStatus || '').toLowerCase();
    const statusLabel = status === 'over' ? 'Over' : status === 'full' ? 'At' : 'Under';
    const capCls = status === 'over' ? 'cap-chip cap-over' : status === 'full' ? 'cap-chip cap-full' : 'cap-chip cap-under';

    // Highlight over-capacity managers
    if (status === 'over') {
      card.classList.add('org-over-capacity');
    }

    // Add capacity status class for color mode
    card.classList.add(`cap-status-${status || 'under'}`);

    // Calculate total team size
    const allPeople = state.people || [];
    const totalTeam = getTotalTeamSize(personKey, allPeople);

    let teamBadgeHtml = '';
    if (totalTeam > 0) {
      teamBadgeHtml = `<div class="org-team-badge">Total team: <span class="team-count">${totalTeam}</span></div>`;
    }

    card.innerHTML = `
      <div class="org-name">${person.FullName || person.Name || ''}</div>
      <div class="org-meta">${[person.Grade || '', person.Office || '', person.Region || ''].filter(Boolean).join(' ‚Ä¢ ')}</div>
      <div class="org-cap">
        <span class="${capCls}"><span>${statusLabel}</span><strong>${person.currentReports || 0}/${person.Capacity || 0}</strong></span>
      </div>
      ${teamBadgeHtml}
    `;

    card.addEventListener('click', onOrgPersonCardClick);

    return card;
  }

  function populateSubGroupSelect(mode) {
    if (!orgSubGroupSelect) return;
    const people = state.people || [];
    const values = new Set();

    people.forEach(p => {
      const val = mode === 'region' ? p.Region : p.Office;
      if (val) values.add(val);
    });

    const sorted = Array.from(values).sort();
    orgSubGroupSelect.innerHTML = '<option value="">-- Select --</option>';
    sorted.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      orgSubGroupSelect.appendChild(opt);
    });
  }

  function onSubGroupSelectChange() {
    const val = orgSubGroupSelect.value;
    if (val) {
      buildOrganigramForGroup(val);
    }
  }

  function buildOrganigramForGroup(groupKey) {
    const people = state.people || [];
    if (!people.length) {
      orgTreeRoot.innerHTML = '<div class="subtle">Upload a file on the Overview tab to see the organigram.</div>';
      return;
    }

    const mode = orgGroupBy.value;
    let groupPeople;
    let groupLabel;

    if (groupKey === 'overall') {
      groupPeople = people;
      groupLabel = 'Overall';
    } else if (mode === 'region') {
      groupPeople = people.filter(p => p.Region === groupKey);
      groupLabel = groupKey;
    } else {
      groupPeople = people.filter(p => p.Office === groupKey);
      groupLabel = groupKey;
    }

    // Render directly to orgTreeRoot (no group list needed)
    renderOrgTreeDirect(groupKey, groupLabel, groupPeople);
  }

  if (orgGroupBy) {
    orgGroupBy.addEventListener('change', onOrgGroupByChange);
  }

  if (orgSubGroupSelect) {
    orgSubGroupSelect.addEventListener('change', onSubGroupSelectChange);
  }

  if (orgPersonSearch) {
    orgPersonSearch.addEventListener('change', onPersonSearchChange);
    orgPersonSearch.addEventListener('input', (e) => {
      // Also trigger on selection from datalist
      const val = e.target.value;
      const people = state.people || [];
      const match = people.find(p => (p.FullName || p.Name || '') === val);
      if (match) onPersonSearchChange();
    });
  }

  if (orgClearBtn) {
    orgClearBtn.addEventListener('click', () => {
      // Reset to Overall view
      if (orgGroupBy) orgGroupBy.value = 'overall';
      if (orgPersonSearch) orgPersonSearch.value = '';
      if (orgSubGroupSelect) orgSubGroupSelect.value = '';
      onOrgGroupByChange();
    });
  }

  // Zoom controls
  function applyOrgZoom() {
    const treeWrap = document.querySelector('.org-tree-wrap');
    if (!treeWrap) return;

    // Apply transform to the orgTreeRoot
    if (orgTreeRoot) {
      orgTreeRoot.style.transform = `scale(${orgZoomLevel})`;
      orgTreeRoot.style.transformOrigin = 'top left';
    }

    // Update display
    if (zoomLevelDisplay) {
      zoomLevelDisplay.textContent = Math.round(orgZoomLevel * 100) + '%';
    }

    // Update button states
    if (zoomInBtn) zoomInBtn.disabled = orgZoomLevel >= ZOOM_MAX;
    if (zoomOutBtn) zoomOutBtn.disabled = orgZoomLevel <= ZOOM_MIN;
  }

  if (zoomInBtn) {
    zoomInBtn.addEventListener('click', () => {
      if (orgZoomLevel < ZOOM_MAX) {
        orgZoomLevel = Math.min(ZOOM_MAX, orgZoomLevel + ZOOM_STEP);
        applyOrgZoom();
      }
    });
  }

  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      if (orgZoomLevel > ZOOM_MIN) {
        orgZoomLevel = Math.max(ZOOM_MIN, orgZoomLevel - ZOOM_STEP);
        applyOrgZoom();
      }
    });
  }

  if (zoomResetBtn) {
    zoomResetBtn.addEventListener('click', () => {
      orgZoomLevel = 1;
      applyOrgZoom();
    });
  }

  // Color by capacity toggle
  if (colorByCapacityCheckbox) {
    colorByCapacityCheckbox.addEventListener('change', () => {
      if (orgTreeRoot) {
        orgTreeRoot.classList.toggle('color-by-capacity', colorByCapacityCheckbox.checked);
      }
    });
  }

  // Export organigram functionality
  const exportOrgPng = document.getElementById('exportOrgPng');
  const exportOrgPdf = document.getElementById('exportOrgPdf');

  function getExportTitle() {
    const mode = orgGroupBy ? orgGroupBy.value : 'overall';
    if (mode === 'overall') return 'Organigram_Overall';
    if (mode === 'region') {
      const region = orgSubGroupSelect ? orgSubGroupSelect.value : '';
      return `Organigram_${region || 'Region'}`;
    }
    if (mode === 'office') {
      const office = orgSubGroupSelect ? orgSubGroupSelect.value : '';
      return `Organigram_${office || 'Office'}`;
    }
    if (mode === 'person') {
      const person = orgPersonSearch ? orgPersonSearch.value : '';
      return `Organigram_${person || 'Person'}`;
    }
    return 'Organigram';
  }

  async function exportOrganigramPng() {
    if (!orgTreeRoot) return;

    const treeWrap = document.querySelector('.org-tree-wrap');
    if (!treeWrap) return;

    // Reset zoom for export
    const oldTransform = orgTreeRoot.style.transform;
    orgTreeRoot.style.transform = 'none';

    try {
      const canvas = await html2canvas(treeWrap, {
        backgroundColor: '#171821',
        scale: 2,
        useCORS: true,
        logging: false,
        scrollX: 0,
        scrollY: 0
      });

      const link = document.createElement('a');
      link.download = `${getExportTitle()}_${new Date().toISOString().split('T')[0]}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    } catch (err) {
      console.error('Export PNG error:', err);
      alert('Could not export as PNG. Please try again.');
    } finally {
      orgTreeRoot.style.transform = oldTransform;
    }
  }

  async function exportOrganigramPdf() {
    if (!orgTreeRoot) return;

    const treeWrap = document.querySelector('.org-tree-wrap');
    if (!treeWrap) return;

    // Reset zoom for export
    const oldTransform = orgTreeRoot.style.transform;
    orgTreeRoot.style.transform = 'none';

    try {
      const canvas = await html2canvas(treeWrap, {
        backgroundColor: '#171821',
        scale: 2,
        useCORS: true,
        logging: false,
        scrollX: 0,
        scrollY: 0
      });

      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;

      // Determine orientation based on content dimensions
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;
      const orientation = imgWidth > imgHeight ? 'landscape' : 'portrait';

      const pdf = new jsPDF({
        orientation: orientation,
        unit: 'mm',
        format: 'a4'
      });

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 10;

      // Calculate scaling to fit page
      const maxWidth = pageWidth - (margin * 2);
      const maxHeight = pageHeight - (margin * 2);
      const ratio = Math.min(maxWidth / (imgWidth / 2), maxHeight / (imgHeight / 2));
      const scaledWidth = (imgWidth / 2) * ratio;
      const scaledHeight = (imgHeight / 2) * ratio;

      // Center on page
      const x = (pageWidth - scaledWidth) / 2;
      const y = margin;

      // Add title
      pdf.setFontSize(14);
      pdf.setTextColor(255, 212, 0);
      pdf.text(getExportTitle().replace(/_/g, ' '), pageWidth / 2, margin / 2 + 3, { align: 'center' });

      pdf.addImage(imgData, 'PNG', x, y + 5, scaledWidth, scaledHeight);

      pdf.save(`${getExportTitle()}_${new Date().toISOString().split('T')[0]}.pdf`);
    } catch (err) {
      console.error('Export PDF error:', err);
      alert('Could not export as PDF. Please try again.');
    } finally {
      orgTreeRoot.style.transform = oldTransform;
    }
  }

  if (exportOrgPng) {
    exportOrgPng.addEventListener('click', exportOrganigramPng);
  }

  if (exportOrgPdf) {
    exportOrgPdf.addEventListener('click', exportOrganigramPdf);
  }

  // Info modal
  const infoBtn = document.getElementById('infoBtn');
  const infoModal = document.getElementById('infoModal');
  const infoModalClose = document.getElementById('infoModalClose');

  if (infoBtn && infoModal) {
    infoBtn.addEventListener('click', () => {
      infoModal.classList.add('active');
    });

    infoModalClose.addEventListener('click', () => {
      infoModal.classList.remove('active');
    });

    infoModal.addEventListener('click', (e) => {
      if (e.target === infoModal) {
        infoModal.classList.remove('active');
      }
    });
  }

  // Change log modal
  const changelogModal = document.getElementById('changelogModal');
  const changelogClose = document.getElementById('changelogClose');

  if (changelogModal) {
    if (changelogClose) {
      changelogClose.addEventListener('click', () => {
        changelogModal.classList.remove('active');
      });
    }

    changelogModal.addEventListener('click', (e) => {
      if (e.target === changelogModal) {
        changelogModal.classList.remove('active');
      }
    });
  }

  // --- Tabs --------------------------------------------------------------
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b===btn));
      document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active', p.id === 'tab-'+tab));

      // Auto-build organigram when switching to that tab
      if (tab === 'organigram' && (state.people || []).length > 0) {
        onOrgGroupByChange();
      }
    });
  });

  // --- Export / Clear / Load buttons -------------------------------------
  const fileInput = document.getElementById('fileInput');
  document.getElementById('btnLoad').addEventListener('click', ()=> fileInput.click());
  document.getElementById('btnClear').addEventListener('click', ()=>{
    state.rawObjects = [];
    state.people = [];
    state.orgTreesByGroup = {};
    fileInput.value = '';
    peopleSearch.value = '';
    renderAll();
  });
  fileInput.addEventListener('change', e=>{
    const file = e.target.files && e.target.files[0];
    if (file) handleFile(file);
    e.target.value = '';
  });

  document.getElementById('btnExport').addEventListener('click', ()=>{
    const people = state.people || [];
    if (!people.length){
      alert('No data to export.');
      return;
    }
    const rows = [
      ['Surname','First Forename','Grade','Grade Level','Discipline','Office','Region','Area','Manager','Is Manager','Capacity','Current reports']
    ];
    people.forEach(p=>{
      rows.push([
        p.Surname || '',
        p.FirstForename || '',
        p.Grade || '',
        p.GradeLevel || '',
        p.Discipline || '',
        p.Office || '',
        p.Region || '',
        p.Area || '',
        p.Manager || '',
        (p.IsManager || p.currentReports>0) ? 'Y' : '',
        p.Capacity || 0,
        p.currentReports || 0
      ]);
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gleeds-line-management-export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // --- Global render -----------------------------------------------------
  function renderAll(){
    renderSummary();
    renderPeopleTable();
    fillFilterOptions();
    populateCapacityRegions();
    populateCapacityPersonList();
    populateOfficeSelect(capacityOfficeSelect, (capacityRegionSelect && capacityRegionSelect.value) || 'Any');
    // Don't auto-populate results - require user to click Search
    const hasData = (state.people || []).length>0;
    if (hasData){
      // Clear results and show instructions
      if (capacityResults) capacityResults.innerHTML = '<div class="subtle">Use the filters above and click <strong>Search</strong> to find managers.</div>';
      fmResults.innerHTML = '<div class="subtle">Use the filters above and click <strong>Suggest</strong> to find managers.</div>';
    } else {
      fmResults.innerHTML = '<div class="subtle">Upload a file first, then use the filters and click <strong>Suggest</strong>.</div>';
      orgTreeRoot.innerHTML = '<div class="subtle">Upload a file on the Overview tab to see the organigram.</div>';
      if (capacityResults) capacityResults.innerHTML = '<div class="subtle">Upload a file first to search for managers.</div>';
    }
  }

  renderAll();
})();
</script>
</body>
</html>
